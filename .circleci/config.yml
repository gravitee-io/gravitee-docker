version: 2.1

parameters:
  gio_product:
    type: enum
    enum: [apim_1x, apim_3x, am_v2, am_v3, oci_lib, none]
    default: none
  dry_run:
    type: boolean
    default: true
    description: "Running in dry run mode means no docker push (Defaults to true)"
  prune:
    type: boolean
    default: false
    description: "Do you want to [docker system prune -f --all] ? (clean up all cached docker images)"
  tag_latest:
    type: boolean
    default: false
    description: "Is this latest version of the Product ?"
  tag_latest_support:
    type: boolean
    default: true
    description: "Is this a latest support version of the Product ? (if so minor version tagging docker images). True by default."
  graviteeio_version:
    type: string
    default: ''
    description: "Gravitee.io Release version number (semver) ?"
  secrethub_org:
    type: string
    default: "graviteeio"
    description: "SecretHub Org to use to fetch secrets ?"
  secrethub_repo:
    type: string
    default: "cicd"
    description: "SecretHub Repo to use to fetch secrets ?"
  graviteeio_java_version:
    type: string
    default: "8"
    description: "The version of java to build and publish [graviteeio/java] Docker image ?"
  graviteeio_python_version:
    type: string
    default: "3-onbuild"
    description: "The docker image tag of the base Python Docker image to build and publish [graviteeio/python] Docker image ?"
orbs:
  secrethub: secrethub/cli@1.1
  gravitee: gravitee-io/gravitee@1.0
jobs:
  empty_job:
    docker:
     - image: alpine
    resource_class: small
    working_directory: /mnt/ramdisk
    steps:
      - run:
          name: "This is a blank job"
          command: echo "No task is executed."
  ce_and_ee_build_n_push_apim_3x_job:
    machine:
      image: 'ubuntu-1604:201903-01'
      resource_class: large
      docker_layer_caching: true    # default - false # requires a Circle CI plan that includes [Docker layer caching feature]
    environment:
      DRY_RUN: << pipeline.parameters.dry_run >>
      TAG_LATEST: << pipeline.parameters.tag_latest >>
      TAG_LATEST_SUPPORT: << pipeline.parameters.tag_latest_support >>
      PRUNE_IT_ALL: << pipeline.parameters.prune >>
      GRAVITEEIO_VERSION: << pipeline.parameters.graviteeio_version >>
      SECRETHUB_ORG: << pipeline.parameters.secrethub_org >>
      SECRETHUB_REPO: << pipeline.parameters.secrethub_repo >>
    steps:
      - run:
          name: "Checking environment"
          command: |
                    echo "Docker version is : "
                    docker version
                    export GRAVITEEIO_VERSION_MAJOR=$(echo "${GRAVITEEIO_VERSION}" | awk -F '.' '{print $1}')
                    export GRAVITEEIO_VERSION_MINOR=$(echo "${GRAVITEEIO_VERSION}" | awk -F '.' '{print $2}')
                    export GRAVITEEIO_VERSION_PATCH=$(echo "${GRAVITEEIO_VERSION}" | awk -F '.' '{print $3}')
                    echo "TAG_LATEST=[${TAG_LATEST}]"
                    echo "SECRETHUB_ORG=[${SECRETHUB_ORG}]"
                    echo "SECRETHUB_REPO=[${SECRETHUB_REPO}]"
                    echo "GRAVITEEIO_VERSION=[${GRAVITEEIO_VERSION}]"
                    echo "GRAVITEEIO_VERSION_MAJOR=[${GRAVITEEIO_VERSION_MAJOR}]"
                    echo "GRAVITEEIO_VERSION_MINOR=[${GRAVITEEIO_VERSION_MINOR}]"
                    echo "GRAVITEEIO_VERSION_PATCH=[${GRAVITEEIO_VERSION_PATCH}]"
                    if ! [ "${GRAVITEEIO_VERSION_MAJOR}" == "3" ]; then
                      echo "The [${GRAVITEEIO_VERSION}] version is not a Gravitee V3 Generation version"
                      exit 3
                    fi;
      - checkout
      - secrethub/install
      - gravitee/git_config:
          secrethub_org: << pipeline.parameters.secrethub_org >>
          secrethub_repo: << pipeline.parameters.secrethub_repo >>
      - run:
          name: "Testing Git Config"
          command: |
                    # ---
                    # Testing if the git config properly configured SSH Agent
                    echo "# ==> Testing if the git config properly configured SSH Agent"
                    ssh -T git@github.com || true
      - run:
          name: "Prune"
          command: |
                    if [ "$PRUNE_IT_ALL" == "true" ]; then
                      echo "Pruning all Docker images "
                      docker system prune -f --all
                    else
                      echo "Skipped Pruning all Docker images "
                    fi;

#      - gravitee/container_images_tests:
#          secrethub_org: << pipeline.parameters.secrethub_org >>
#          secrethub_repo: << pipeline.parameters.secrethub_repo >>
#          gio_release_version: << pipeline.parameters.graviteeio_version >>

      - run:
          name: "Docker build: Gravitee APIM Containers Community Edition"
          command: |
                    pwd

                    # https://app.circleci.com/pipelines/github/gravitee-io/gravitee-docker/240/workflows/eb794414-5b8e-4e84-b500-29aa41ac6de1/jobs/374
                    if [ "${GRAVITEEIO_VERSION}" == "3.0.16" ]; then
                      echo "# ------------------------------------------------------------------- #"
                      echo "  Skipping to apply docker build fix only for APIM 3.0.16 and 3.0.17"
                      echo "# ------------------------------------------------------------------- #"
                      exit 0
                    fi;
                    if [ "${GRAVITEEIO_VERSION}" == "3.0.17" ]; then
                      echo "# ------------------------------------------------------------------- #"
                      echo "   Skipping to apply docker build fix only for APIM 3.0.16 and 3.0.17"
                      echo "# ------------------------------------------------------------------- #"
                      exit 0
                    fi;
                    ls -allh
                    export OPS_HOME=$(pwd)
                    echo "Gravitee Containers :  Docker build APIM Gateway"
                    export GRAVITEEIO_VERSION_MAJOR=$(echo "${GRAVITEEIO_VERSION}" | awk -F '.' '{print $1}')
                    export GRAVITEEIO_VERSION_MINOR=$(echo "${GRAVITEEIO_VERSION}" | awk -F '.' '{print $2}')
                    export GRAVITEEIO_VERSION_PATCH=$(echo "${GRAVITEEIO_VERSION}" | awk -F '.' '{print $3}')

                    export DOCKER_FULL_TAG="${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}.${GRAVITEEIO_VERSION_PATCH}"
                    export DOCKER_BUILD_ARGS="--build-arg GRAVITEEIO_VERSION=${GRAVITEEIO_VERSION}"

                    export DOCKER_WORKSHOP=$(mktemp -d -t "apim-XXXXXXXXXX")
                    export GIT_SSH_URI=git@github.com:gravitee-io/gravitee-api-management.git
                    cd ${OPS_HOME}
                    git clone ${GIT_SSH_URI} ${DOCKER_WORKSHOP}
                    cd ${DOCKER_WORKSHOP}
                    git checkout "${GRAVITEEIO_VERSION}"
                    cd ${OPS_HOME}

                    #Management API
                    echo " Docker build: Gravitee APIM Management API version [${GRAVITEEIO_VERSION}]"
                    export DOCKER_IMAGE_NAME="graviteeio/apim-management-api"
                    echo "docker build ${DOCKER_BUILD_ARGS} -t ${DOCKER_IMAGE_NAME}:${DOCKER_FULL_TAG} ${DOCKER_WORKSHOP}/gravitee-apim-rest-api/docker"
                    docker build ${DOCKER_BUILD_ARGS} -t ${DOCKER_IMAGE_NAME}:${DOCKER_FULL_TAG} ${DOCKER_WORKSHOP}/gravitee-apim-rest-api/docker

                    #Gateway
                    echo " Docker build: Gravitee APIM Gateway version [${GRAVITEEIO_VERSION}]"
                    export DOCKER_IMAGE_NAME="graviteeio/apim-gateway"
                    echo "docker build ${DOCKER_BUILD_ARGS} -t ${DOCKER_IMAGE_NAME}:${DOCKER_FULL_TAG} ${DOCKER_WORKSHOP}/gravitee-apim-gateway/docker"
                    docker build ${DOCKER_BUILD_ARGS} -t ${DOCKER_IMAGE_NAME}:${DOCKER_FULL_TAG} ${DOCKER_WORKSHOP}/gravitee-apim-gateway/docker

                    #Console
                    echo " Docker build: Gravitee APIM Console UI version [${GRAVITEEIO_VERSION}]"
                    export DOCKER_IMAGE_NAME="graviteeio/apim-management-ui"
                    echo "docker build ${DOCKER_BUILD_ARGS} -t ${DOCKER_IMAGE_NAME}:${DOCKER_FULL_TAG} ${DOCKER_WORKSHOP}/gravitee-apim-console-webui/docker"
                    docker build ${DOCKER_BUILD_ARGS} -t ${DOCKER_IMAGE_NAME}:${DOCKER_FULL_TAG} ${DOCKER_WORKSHOP}/gravitee-apim-console-webui/docker

                    #Portal
                    echo " Docker build: Gravitee APIM Portal UI version [${GRAVITEEIO_VERSION}]"
                    export DOCKER_IMAGE_NAME="graviteeio/apim-portal-ui"
                    echo "docker build ${DOCKER_BUILD_ARGS} -t ${DOCKER_IMAGE_NAME}:${DOCKER_FULL_TAG} ${DOCKER_WORKSHOP}/gravitee-apim-portal-webui/docker"
                    docker build ${DOCKER_BUILD_ARGS} -t ${DOCKER_IMAGE_NAME}:${DOCKER_FULL_TAG} ${DOCKER_WORKSHOP}/gravitee-apim-portal-webui/docker

      - gravitee/container_images_build_apim_3_0_16_fix:
          secrethub_org: << pipeline.parameters.secrethub_org >>
          secrethub_repo: << pipeline.parameters.secrethub_repo >>
          gio_release_version: << pipeline.parameters.graviteeio_version >>

      - run:
          name: "Docker tags: Gravitee APIM Containers Community Edition"
          command: |
                    pwd
                    ls -allh
                    export GRAVITEEIO_VERSION_MAJOR=$(echo "${GRAVITEEIO_VERSION}" | awk -F '.' '{print $1}')
                    export GRAVITEEIO_VERSION_MINOR=$(echo "${GRAVITEEIO_VERSION}" | awk -F '.' '{print $2}')
                    export GRAVITEEIO_VERSION_PATCH=$(echo "${GRAVITEEIO_VERSION}" | awk -F '.' '{print $3}')
                    export DOCKER_FULL_TAG="${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}.${GRAVITEEIO_VERSION_PATCH}"

                    export DOCKER_IMAGE_NAME="graviteeio/apim-gateway"
                    if [ "$TAG_LATEST" == "true" ]; then
                        echo "Gravitee Containers :  Docker tags, Releasing Docker images as latest"
                        docker tag ${DOCKER_IMAGE_NAME}:${DOCKER_FULL_TAG} ${DOCKER_IMAGE_NAME}:latest
                        # docker push ${DOCKER_IMAGE_NAME}:latest
                        docker tag ${DOCKER_IMAGE_NAME}:${DOCKER_FULL_TAG} ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}
                        # docker push ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}
                        docker tag ${DOCKER_IMAGE_NAME}:${DOCKER_FULL_TAG} ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}
                        # docker push ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}
                    else
                        if [ "$TAG_LATEST_SUPPORT" == "true" ]; then
                            echo "Gravitee Containers :  Docker tags, Releasing Docker images as latest support"
                            docker tag ${DOCKER_IMAGE_NAME}:${DOCKER_FULL_TAG} ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}
                            # docker push ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}
                        else
                            echo "Gravitee Containers :  Docker tags, Releasing Docker images as NON-latest"
                        fi
                    fi

                    export DOCKER_IMAGE_NAME="graviteeio/apim-management-api"
                    if [ "$TAG_LATEST" == "true" ]; then
                        echo "Gravitee Containers :  Docker tags, Releasing Docker images as latest"
                        docker tag ${DOCKER_IMAGE_NAME}:${DOCKER_FULL_TAG} ${DOCKER_IMAGE_NAME}:latest
                        # docker push ${DOCKER_IMAGE_NAME}:latest
                        docker tag ${DOCKER_IMAGE_NAME}:${DOCKER_FULL_TAG} ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}
                        # docker push ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}
                        docker tag ${DOCKER_IMAGE_NAME}:${DOCKER_FULL_TAG} ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}
                        # docker push ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}
                    else
                        if [ "$TAG_LATEST_SUPPORT" == "true" ]; then
                            echo "Gravitee Containers :  Docker tags, Releasing Docker images as latest support"
                            docker tag ${DOCKER_IMAGE_NAME}:${DOCKER_FULL_TAG} ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}
                            # docker push ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}
                        else
                            echo "Gravitee Containers :  Docker tags, Releasing Docker images as NON-latest"
                        fi
                    fi
                    export DOCKER_IMAGE_NAME="graviteeio/apim-management-ui"
                    if [ "$TAG_LATEST" == "true" ]; then
                        echo "Gravitee Containers :  Docker tags, Releasing Docker images as latest"
                        docker tag ${DOCKER_IMAGE_NAME}:${DOCKER_FULL_TAG} ${DOCKER_IMAGE_NAME}:latest
                        # docker push ${DOCKER_IMAGE_NAME}:latest
                        docker tag ${DOCKER_IMAGE_NAME}:${DOCKER_FULL_TAG} ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}
                        # docker push ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}
                        docker tag ${DOCKER_IMAGE_NAME}:${DOCKER_FULL_TAG} ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}
                        # docker push ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}
                    else
                        if [ "$TAG_LATEST_SUPPORT" == "true" ]; then
                            echo "Gravitee Containers :  Docker tags, Releasing Docker images as latest support"
                            docker tag ${DOCKER_IMAGE_NAME}:${DOCKER_FULL_TAG} ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}
                            # docker push ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}
                        else
                            echo "Gravitee Containers :  Docker tags, Releasing Docker images as NON-latest"
                        fi
                    fi
                    export DOCKER_IMAGE_NAME="graviteeio/apim-portal-ui"
                    if [ "$TAG_LATEST" == "true" ]; then
                        echo "Gravitee Containers :  Docker tags, Releasing Docker images as latest"
                        docker tag ${DOCKER_IMAGE_NAME}:${DOCKER_FULL_TAG} ${DOCKER_IMAGE_NAME}:latest
                        # docker push ${DOCKER_IMAGE_NAME}:latest
                        docker tag ${DOCKER_IMAGE_NAME}:${DOCKER_FULL_TAG} ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}
                        # docker push ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}
                        docker tag ${DOCKER_IMAGE_NAME}:${DOCKER_FULL_TAG} ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}
                        # docker push ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}
                    else
                        if [ "$TAG_LATEST_SUPPORT" == "true" ]; then
                            echo "Gravitee Containers :  Docker tags, Releasing Docker images as latest support"
                            docker tag ${DOCKER_IMAGE_NAME}:${DOCKER_FULL_TAG} ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}
                            # docker push ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}
                        else
                            echo "Gravitee Containers :  Docker tags, Releasing Docker images as NON-latest"
                        fi
                    fi

                    docker images
      - run:
          name: "Docker Tests: Gravitee APIM Containers Community Edition"
          command: |
                    pwd
                    ls -allh
                    echo "Gravitee Containers :  Testing the Docker image before pushing it"
                    echo "No tests implemented yet."
      - gravitee/docker_login:
          secrethub_org: << pipeline.parameters.secrethub_org >>
          secrethub_repo: << pipeline.parameters.secrethub_repo >>
      - run:
          name: "Docker push: Gravitee APIM Containers Community Edition"
          command: |
                    echo "Gravitee Containers : Docker push"
                    export GRAVITEEIO_VERSION_MAJOR=$(echo "${GRAVITEEIO_VERSION}" | awk -F '.' '{print $1}')
                    export GRAVITEEIO_VERSION_MINOR=$(echo "${GRAVITEEIO_VERSION}" | awk -F '.' '{print $2}')
                    export GRAVITEEIO_VERSION_PATCH=$(echo "${GRAVITEEIO_VERSION}" | awk -F '.' '{print $3}')
                    docker images
                    if [ "$DRY_RUN" == "true" ]; then
                      echo "Skipped docker push in dry run mode"
                      exit 0
                    fi;
                    export DOCKER_FULL_TAG="${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}.${GRAVITEEIO_VERSION_PATCH}"


                    export DOCKER_IMAGE_NAME="graviteeio/apim-gateway"
                    docker push ${DOCKER_IMAGE_NAME}:${DOCKER_FULL_TAG}
                    if [ "$TAG_LATEST" == "true" ]; then
                        echo "Gravitee Containers :  Docker tags, Releasing Docker images as latest"
                        docker push ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}
                        docker push ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}
                        docker push ${DOCKER_IMAGE_NAME}:latest
                    else
                        if [ "$TAG_LATEST_SUPPORT" == "true" ]; then
                            echo "Gravitee Containers :  Docker tags, Releasing Docker images as latest support"
                            docker push ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}
                        else
                            echo "Gravitee Containers :  Docker tags, Releasing Docker images as NON-latest"
                        fi
                    fi

                    export DOCKER_IMAGE_NAME="graviteeio/apim-management-api"
                    docker push ${DOCKER_IMAGE_NAME}:${DOCKER_FULL_TAG}
                    if [ "$TAG_LATEST" == "true" ]; then
                        echo "Gravitee Containers :  Docker tags, Releasing Docker images as latest"
                        docker push ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}
                        docker push ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}
                        docker push ${DOCKER_IMAGE_NAME}:latest
                    else
                        if [ "$TAG_LATEST_SUPPORT" == "true" ]; then
                            echo "Gravitee Containers :  Docker tags, Releasing Docker images as latest support"
                            docker push ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}
                        else
                            echo "Gravitee Containers :  Docker tags, Releasing Docker images as NON-latest"
                        fi
                    fi

                    export DOCKER_IMAGE_NAME="graviteeio/apim-management-ui"
                    docker push ${DOCKER_IMAGE_NAME}:${DOCKER_FULL_TAG}
                    if [ "$TAG_LATEST" == "true" ]; then
                        echo "Gravitee Containers :  Docker tags, Releasing Docker images as latest"
                        docker push ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}
                        docker push ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}
                        docker push ${DOCKER_IMAGE_NAME}:latest
                    else
                        if [ "$TAG_LATEST_SUPPORT" == "true" ]; then
                            echo "Gravitee Containers :  Docker tags, Releasing Docker images as latest support"
                            docker push ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}
                        else
                            echo "Gravitee Containers :  Docker tags, Releasing Docker images as NON-latest"
                        fi
                    fi

                    export DOCKER_IMAGE_NAME="graviteeio/apim-portal-ui"
                    docker push ${DOCKER_IMAGE_NAME}:${DOCKER_FULL_TAG}
                    if [ "$TAG_LATEST" == "true" ]; then
                        echo "Gravitee Containers :  Docker tags, Releasing Docker images as latest"
                        docker push ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}
                        docker push ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}
                        docker push ${DOCKER_IMAGE_NAME}:latest
                    else
                        if [ "$TAG_LATEST_SUPPORT" == "true" ]; then
                            echo "Gravitee Containers :  Docker tags, Releasing Docker images as latest support"
                            docker push ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}
                        else
                            echo "Gravitee Containers :  Docker tags, Releasing Docker images as NON-latest"
                        fi
                    fi
      - run:
          name: "Checking environment"
          command: |
                    echo "Docker version is : "
                    docker version
                    export GRAVITEEIO_VERSION_MAJOR=$(echo "${GRAVITEEIO_VERSION}" | awk -F '.' '{print $1}')
                    export GRAVITEEIO_VERSION_MINOR=$(echo "${GRAVITEEIO_VERSION}" | awk -F '.' '{print $2}')
                    export GRAVITEEIO_VERSION_PATCH=$(echo "${GRAVITEEIO_VERSION}" | awk -F '.' '{print $3}')
                    echo "TAG_LATEST=[${TAG_LATEST}]"
                    echo "SECRETHUB_ORG=[${SECRETHUB_ORG}]"
                    echo "SECRETHUB_REPO=[${SECRETHUB_REPO}]"
                    echo "GRAVITEEIO_VERSION=[${GRAVITEEIO_VERSION}]"
                    echo "GRAVITEEIO_VERSION_MAJOR=[${GRAVITEEIO_VERSION_MAJOR}]"
                    echo "GRAVITEEIO_VERSION_MINOR=[${GRAVITEEIO_VERSION_MINOR}]"
                    echo "GRAVITEEIO_VERSION_PATCH=[${GRAVITEEIO_VERSION_PATCH}]"
                    # ---
                    # Testing if the git config properly configured SSH Agent
                    # echo "# ==> Testing if the git config properly configured SSH Agent"
                    # ssh -T git@github.com || true

      - run:
          name: "Docker build: Gravitee APIM Containers Entreprise Edition"
          command: |
                    pwd
                    ls -allh

                    echo "Gravitee Containers :  Docker build APIM Gateway"
                    export GRAVITEEIO_VERSION_MAJOR=$(echo "${GRAVITEEIO_VERSION}" | awk -F '.' '{print $1}')
                    export GRAVITEEIO_VERSION_MINOR=$(echo "${GRAVITEEIO_VERSION}" | awk -F '.' '{print $2}')
                    export GRAVITEEIO_VERSION_PATCH=$(echo "${GRAVITEEIO_VERSION}" | awk -F '.' '{print $3}')

                    export DOCKER_FULL_TAG="${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}.${GRAVITEEIO_VERSION_PATCH}-ee"
                    export DOCKER_BUILD_ARGS="--build-arg GRAVITEEIO_VERSION=${GRAVITEEIO_VERSION}"



                    echo " Docker build: Gravitee APIM Gateway version [${GRAVITEEIO_VERSION}]"
                    export DOCKER_IMAGE_NAME="graviteeio/apim-gateway"
                    echo "docker build ${DOCKER_BUILD_ARGS} -t ${DOCKER_IMAGE_NAME}:${DOCKER_FULL_TAG} enterprise/apim/3.x/gateway"
                    docker build ${DOCKER_BUILD_ARGS} -t ${DOCKER_IMAGE_NAME}:${DOCKER_FULL_TAG} enterprise/apim/3.x/gateway



                    echo " Docker build: Gravitee APIM Management API version [${GRAVITEEIO_VERSION}]"
                    export DOCKER_IMAGE_NAME="graviteeio/apim-management-api"
                    echo "docker build ${DOCKER_BUILD_ARGS} -t ${DOCKER_IMAGE_NAME}:${DOCKER_FULL_TAG} enterprise/apim/3.x/management-api"
                    docker build ${DOCKER_BUILD_ARGS} -t ${DOCKER_IMAGE_NAME}:${DOCKER_FULL_TAG} enterprise/apim/3.x/management-api



                    echo " Docker build: Gravitee APIM Management UI version [${GRAVITEEIO_VERSION}]"
                    export DOCKER_IMAGE_NAME="graviteeio/apim-management-ui"
                    echo "docker build ${DOCKER_BUILD_ARGS} -t ${DOCKER_IMAGE_NAME}:${DOCKER_FULL_TAG} enterprise/apim/3.x/management-ui"
                    docker build ${DOCKER_BUILD_ARGS} -t ${DOCKER_IMAGE_NAME}:${DOCKER_FULL_TAG} enterprise/apim/3.x/management-ui



                    echo " Docker build: Gravitee APIM Portal UI version [${GRAVITEEIO_VERSION}]"
                    export DOCKER_IMAGE_NAME="graviteeio/apim-portal-ui"
                    echo "docker build ${DOCKER_BUILD_ARGS} -t ${DOCKER_IMAGE_NAME}:${DOCKER_FULL_TAG} enterprise/apim/3.x/portal-ui"
                    docker build ${DOCKER_BUILD_ARGS} -t ${DOCKER_IMAGE_NAME}:${DOCKER_FULL_TAG} enterprise/apim/3.x/portal-ui

      - run:
          name: "Docker tags: Gravitee APIM Containers Entreprise Edition"
          command: |
                    pwd
                    ls -allh
                    export GRAVITEEIO_VERSION_MAJOR=$(echo "${GRAVITEEIO_VERSION}" | awk -F '.' '{print $1}')
                    export GRAVITEEIO_VERSION_MINOR=$(echo "${GRAVITEEIO_VERSION}" | awk -F '.' '{print $2}')
                    export GRAVITEEIO_VERSION_PATCH=$(echo "${GRAVITEEIO_VERSION}" | awk -F '.' '{print $3}')
                    export DOCKER_FULL_TAG="${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}.${GRAVITEEIO_VERSION_PATCH}-ee"

                    export DOCKER_IMAGE_NAME="graviteeio/apim-gateway"
                    if [ "$TAG_LATEST" == "true" ]; then
                        echo "Gravitee Containers :  Docker tags, Releasing Docker images as latest"
                        docker tag ${DOCKER_IMAGE_NAME}:${DOCKER_FULL_TAG} ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}-ee
                        # docker push ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}
                        docker tag ${DOCKER_IMAGE_NAME}:${DOCKER_FULL_TAG} ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}-ee
                        # docker push ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}-ee
                    else
                        if [ "$TAG_LATEST_SUPPORT" == "true" ]; then
                            echo "Gravitee Containers :  Docker tags, Releasing Docker images as latest support"
                            docker tag ${DOCKER_IMAGE_NAME}:${DOCKER_FULL_TAG} ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}-ee
                            # docker push ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}-ee
                        else
                            echo "Gravitee Containers :  Docker tags, Releasing Docker images as NON-latest"
                        fi
                    fi
                    export DOCKER_IMAGE_NAME="graviteeio/apim-management-api"
                    if [ "$TAG_LATEST" == "true" ]; then
                        echo "Gravitee Containers :  Docker tags, Releasing Docker images as latest"
                        docker tag ${DOCKER_IMAGE_NAME}:${DOCKER_FULL_TAG} ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}-ee
                        # docker push ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}-ee
                        docker tag ${DOCKER_IMAGE_NAME}:${DOCKER_FULL_TAG} ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}-ee
                        # docker push ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}-ee
                    else
                        if [ "$TAG_LATEST_SUPPORT" == "true" ]; then
                            echo "Gravitee Containers :  Docker tags, Releasing Docker images as latest support"
                            docker tag ${DOCKER_IMAGE_NAME}:${DOCKER_FULL_TAG} ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}-ee
                            # docker push ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}-ee
                        else
                            echo "Gravitee Containers :  Docker tags, Releasing Docker images as NON-latest"
                        fi
                    fi
                    export DOCKER_IMAGE_NAME="graviteeio/apim-management-ui"
                    if [ "$TAG_LATEST" == "true" ]; then
                        echo "Gravitee Containers :  Docker tags, Releasing Docker images as latest"
                        docker tag ${DOCKER_IMAGE_NAME}:${DOCKER_FULL_TAG} ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}-ee
                        # docker push ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}-ee
                        docker tag ${DOCKER_IMAGE_NAME}:${DOCKER_FULL_TAG} ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}-ee
                        # docker push ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}-ee
                    else
                        if [ "$TAG_LATEST_SUPPORT" == "true" ]; then
                            echo "Gravitee Containers :  Docker tags, Releasing Docker images as latest support"
                            docker tag ${DOCKER_IMAGE_NAME}:${DOCKER_FULL_TAG} ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}-ee
                            # docker push ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}-ee
                        else
                            echo "Gravitee Containers :  Docker tags, Releasing Docker images as NON-latest"
                        fi
                    fi
                    export DOCKER_IMAGE_NAME="graviteeio/apim-portal-ui"
                    if [ "$TAG_LATEST" == "true" ]; then
                        echo "Gravitee Containers :  Docker tags, Releasing Docker images as latest"
                        docker tag ${DOCKER_IMAGE_NAME}:${DOCKER_FULL_TAG} ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}-ee
                        # docker push ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}-ee
                        docker tag ${DOCKER_IMAGE_NAME}:${DOCKER_FULL_TAG} ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}-ee
                        # docker push ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}-ee
                    else
                        if [ "$TAG_LATEST_SUPPORT" == "true" ]; then
                            echo "Gravitee Containers :  Docker tags, Releasing Docker images as latest support"
                            docker tag ${DOCKER_IMAGE_NAME}:${DOCKER_FULL_TAG} ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}-ee
                            # docker push ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}-ee
                        else
                            echo "Gravitee Containers :  Docker tags, Releasing Docker images as NON-latest"
                        fi
                    fi

                    docker images
      - run:
          name: "Docker Tests: Gravitee APIM Containers Entreprise Edition"
          command: |
                    pwd
                    ls -allh
                    echo "Gravitee Containers :  Testing the Docker image before pushing it"
                    echo "No tests implemented yet."
      - gravitee/docker_login:
          secrethub_org: << pipeline.parameters.secrethub_org >>
          secrethub_repo: << pipeline.parameters.secrethub_repo >>
      - run:
          name: "Docker push: Gravitee APIM Containers Entreprise Edition"
          command: |
                    echo "Gravitee Containers : Docker push"
                    export GRAVITEEIO_VERSION_MAJOR=$(echo "${GRAVITEEIO_VERSION}" | awk -F '.' '{print $1}')
                    export GRAVITEEIO_VERSION_MINOR=$(echo "${GRAVITEEIO_VERSION}" | awk -F '.' '{print $2}')
                    export GRAVITEEIO_VERSION_PATCH=$(echo "${GRAVITEEIO_VERSION}" | awk -F '.' '{print $3}')
                    docker images
                    if [ "$DRY_RUN" == "true" ]; then
                      echo "Skipped docker push in dry run mode"
                      exit 0
                    fi;

                    export DOCKER_FULL_TAG="${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}.${GRAVITEEIO_VERSION_PATCH}-ee"


                    export DOCKER_IMAGE_NAME="graviteeio/apim-gateway"
                    docker push ${DOCKER_IMAGE_NAME}:${DOCKER_FULL_TAG}
                    if [ "$TAG_LATEST" == "true" ]; then
                        echo "Gravitee Containers :  Docker tags, Releasing Docker images as latest"
                        docker push ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}-ee
                        docker push ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}-ee
                    else
                        if [ "$TAG_LATEST_SUPPORT" == "true" ]; then
                            echo "Gravitee Containers :  Docker tags, Releasing Docker images as latest support"
                            docker push ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}-ee
                        else
                            echo "Gravitee Containers :  Docker tags, Releasing Docker images as NON-latest"
                        fi
                    fi

                    export DOCKER_IMAGE_NAME="graviteeio/apim-management-api"
                    docker push ${DOCKER_IMAGE_NAME}:${DOCKER_FULL_TAG}
                    if [ "$TAG_LATEST" == "true" ]; then
                        echo "Gravitee Containers :  Docker tags, Releasing Docker images as latest"
                        docker push ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}-ee
                        docker push ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}-ee
                    else
                        if [ "$TAG_LATEST_SUPPORT" == "true" ]; then
                            echo "Gravitee Containers :  Docker tags, Releasing Docker images as latest support"
                            docker push ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}-ee
                        else
                            echo "Gravitee Containers :  Docker tags, Releasing Docker images as NON-latest"
                        fi
                    fi

                    export DOCKER_IMAGE_NAME="graviteeio/apim-management-ui"
                    docker push ${DOCKER_IMAGE_NAME}:${DOCKER_FULL_TAG}
                    if [ "$TAG_LATEST" == "true" ]; then
                        echo "Gravitee Containers :  Docker tags, Releasing Docker images as latest"
                        docker push ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}-ee
                        docker push ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}-ee
                    else
                        if [ "$TAG_LATEST_SUPPORT" == "true" ]; then
                            echo "Gravitee Containers :  Docker tags, Releasing Docker images as latest support"
                            docker push ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}-ee
                        else
                            echo "Gravitee Containers :  Docker tags, Releasing Docker images as NON-latest"
                        fi
                    fi

                    export DOCKER_IMAGE_NAME="graviteeio/apim-portal-ui"
                    docker push ${DOCKER_IMAGE_NAME}:${DOCKER_FULL_TAG}
                    if [ "$TAG_LATEST" == "true" ]; then
                        echo "Gravitee Containers :  Docker tags, Releasing Docker images as latest"
                        docker push ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}-ee
                        docker push ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}-ee
                    else
                        if [ "$TAG_LATEST_SUPPORT" == "true" ]; then
                            echo "Gravitee Containers :  Docker tags, Releasing Docker images as latest support"
                            docker push ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}-ee
                        else
                            echo "Gravitee Containers :  Docker tags, Releasing Docker images as NON-latest"
                        fi
                    fi

  ce_and_ee_build_n_push_apim_1x_job:
    machine:
      image: 'ubuntu-1604:201903-01'
      resource_class: large
      docker_layer_caching: true    # default - false # requires a Circle CI plan that includes [Docker layer caching feature]
    environment:
      DRY_RUN: << pipeline.parameters.dry_run >>
      TAG_LATEST: << pipeline.parameters.tag_latest >>
      TAG_LATEST_SUPPORT: << pipeline.parameters.tag_latest_support >>
      PRUNE_IT_ALL: << pipeline.parameters.prune >>
      GRAVITEEIO_VERSION: << pipeline.parameters.graviteeio_version >>
      SECRETHUB_ORG: << pipeline.parameters.secrethub_org >>
      SECRETHUB_REPO: << pipeline.parameters.secrethub_repo >>
    steps:
      - run:
          name: "Checking environment"
          command: |
                    echo "Docker version is : "
                    docker version
                    export GRAVITEEIO_VERSION_MAJOR=$(echo "${GRAVITEEIO_VERSION}" | awk -F '.' '{print $1}')
                    export GRAVITEEIO_VERSION_MINOR=$(echo "${GRAVITEEIO_VERSION}" | awk -F '.' '{print $2}')
                    export GRAVITEEIO_VERSION_PATCH=$(echo "${GRAVITEEIO_VERSION}" | awk -F '.' '{print $3}')
                    echo "TAG_LATEST=[${TAG_LATEST}]"
                    echo "SECRETHUB_ORG=[${SECRETHUB_ORG}]"
                    echo "SECRETHUB_REPO=[${SECRETHUB_REPO}]"
                    echo "GRAVITEEIO_VERSION=[${GRAVITEEIO_VERSION}]"
                    echo "GRAVITEEIO_VERSION_MAJOR=[${GRAVITEEIO_VERSION_MAJOR}]"
                    echo "GRAVITEEIO_VERSION_MINOR=[${GRAVITEEIO_VERSION_MINOR}]"
                    echo "GRAVITEEIO_VERSION_PATCH=[${GRAVITEEIO_VERSION_PATCH}]"
                    if ! [ "${GRAVITEEIO_VERSION_MAJOR}" == "1" ]; then
                      echo "The [${GRAVITEEIO_VERSION}] version is not a Gravitee V1 Generation version"
                      exit 3
                    fi;

      - checkout
      - secrethub/install
      - run:
          name: "Prune"
          command: |
                    if [ "$PRUNE_IT_ALL" == "true" ]; then
                      echo "Pruning all Docker images "
                      docker system prune -f --all
                    else
                      echo "Skipped Pruning all Docker images "
                    fi;

      - run:
          name: "Docker build: Gravitee APIM Containers Community Edition"
          command: |
                    pwd
                    ls -allh
                    echo "Gravitee Containers :  Docker build"
                    export GRAVITEEIO_VERSION_MAJOR=$(echo "${GRAVITEEIO_VERSION}" | awk -F '.' '{print $1}')
                    export GRAVITEEIO_VERSION_MINOR=$(echo "${GRAVITEEIO_VERSION}" | awk -F '.' '{print $2}')
                    export GRAVITEEIO_VERSION_PATCH=$(echo "${GRAVITEEIO_VERSION}" | awk -F '.' '{print $3}')
                    export DOCKER_FULL_TAG="${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}.${GRAVITEEIO_VERSION_PATCH}"
                    export DOCKER_BUILD_ARGS="--build-arg GRAVITEEIO_VERSION=${GRAVITEEIO_VERSION}"

                    echo " Docker build: Gravitee APIM Gateway version [${GRAVITEEIO_VERSION}]"
                    export DOCKER_IMAGE_NAME="graviteeio/gateway"
                    echo "docker build ${DOCKER_BUILD_ARGS} -t ${DOCKER_IMAGE_NAME}:${DOCKER_FULL_TAG} images/gateway"
                    docker build ${DOCKER_BUILD_ARGS} -t ${DOCKER_IMAGE_NAME}:${DOCKER_FULL_TAG} images/gateway

                    echo " Docker build: Gravitee APIM Management API version [${GRAVITEEIO_VERSION}]"
                    export DOCKER_IMAGE_NAME="graviteeio/management-api"
                    echo "docker build ${DOCKER_BUILD_ARGS} -t ${DOCKER_IMAGE_NAME}:${DOCKER_FULL_TAG} images/management-api"
                    docker build ${DOCKER_BUILD_ARGS} -t ${DOCKER_IMAGE_NAME}:${DOCKER_FULL_TAG} images/management-api

                    echo " Docker build: Gravitee APIM Management UI version [${GRAVITEEIO_VERSION}]"
                    export DOCKER_IMAGE_NAME="graviteeio/management-ui"
                    echo "docker build ${DOCKER_BUILD_ARGS} -t ${DOCKER_IMAGE_NAME}:${DOCKER_FULL_TAG} images/management-ui"
                    docker build ${DOCKER_BUILD_ARGS} -t ${DOCKER_IMAGE_NAME}:${DOCKER_FULL_TAG} images/management-ui

      - run:
          name: "Docker tags: Gravitee APIM Containers Community Edition"
          command: |
                    pwd
                    ls -allh
                    export GRAVITEEIO_VERSION_MAJOR=$(echo "${GRAVITEEIO_VERSION}" | awk -F '.' '{print $1}')
                    export GRAVITEEIO_VERSION_MINOR=$(echo "${GRAVITEEIO_VERSION}" | awk -F '.' '{print $2}')
                    export GRAVITEEIO_VERSION_PATCH=$(echo "${GRAVITEEIO_VERSION}" | awk -F '.' '{print $3}')
                    export DOCKER_FULL_TAG="${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}.${GRAVITEEIO_VERSION_PATCH}"

                    export DOCKER_IMAGE_NAME="graviteeio/gateway"
                    if [ "$TAG_LATEST" == "true" ]; then
                        echo "Gravitee Containers :  Docker tags, Releasing Docker images as latest"
                        docker tag ${DOCKER_IMAGE_NAME}:${DOCKER_FULL_TAG} ${DOCKER_IMAGE_NAME}:latest
                        # docker push ${DOCKER_IMAGE_NAME}:latest
                        docker tag ${DOCKER_IMAGE_NAME}:${DOCKER_FULL_TAG} ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}
                        # docker push ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}
                        docker tag ${DOCKER_IMAGE_NAME}:${DOCKER_FULL_TAG} ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}
                        # docker push ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}
                    else
                        if [ "$TAG_LATEST_SUPPORT" == "true" ]; then
                            echo "Gravitee Containers :  Docker tags, Releasing Docker images as latest support"
                            docker tag ${DOCKER_IMAGE_NAME}:${DOCKER_FULL_TAG} ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}
                            # docker push ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}
                        else
                            echo "Gravitee Containers :  Docker tags, Releasing Docker images as NON-latest"
                        fi
                    fi
                    export DOCKER_IMAGE_NAME="graviteeio/management-api"
                    if [ "$TAG_LATEST" == "true" ]; then
                        echo "Gravitee Containers :  Docker tags, Releasing Docker images as latest"
                        docker tag ${DOCKER_IMAGE_NAME}:${DOCKER_FULL_TAG} ${DOCKER_IMAGE_NAME}:latest
                        # docker push ${DOCKER_IMAGE_NAME}:latest
                        docker tag ${DOCKER_IMAGE_NAME}:${DOCKER_FULL_TAG} ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}
                        # docker push ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}
                        docker tag ${DOCKER_IMAGE_NAME}:${DOCKER_FULL_TAG} ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}
                        # docker push ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}
                    else
                        if [ "$TAG_LATEST_SUPPORT" == "true" ]; then
                            echo "Gravitee Containers :  Docker tags, Releasing Docker images as latest support"
                            docker tag ${DOCKER_IMAGE_NAME}:${DOCKER_FULL_TAG} ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}
                            # docker push ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}
                        else
                            echo "Gravitee Containers :  Docker tags, Releasing Docker images as NON-latest"
                        fi
                    fi
                    export DOCKER_IMAGE_NAME="graviteeio/management-ui"
                    if [ "$TAG_LATEST" == "true" ]; then
                        echo "Gravitee Containers :  Docker tags, Releasing Docker images as latest"
                        docker tag ${DOCKER_IMAGE_NAME}:${DOCKER_FULL_TAG} ${DOCKER_IMAGE_NAME}:latest
                        # docker push ${DOCKER_IMAGE_NAME}:latest
                        docker tag ${DOCKER_IMAGE_NAME}:${DOCKER_FULL_TAG} ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}
                        # docker push ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}
                        docker tag ${DOCKER_IMAGE_NAME}:${DOCKER_FULL_TAG} ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}
                        # docker push ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}
                    else
                        if [ "$TAG_LATEST_SUPPORT" == "true" ]; then
                            echo "Gravitee Containers :  Docker tags, Releasing Docker images as latest support"
                            docker tag ${DOCKER_IMAGE_NAME}:${DOCKER_FULL_TAG} ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}
                            # docker push ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}
                        else
                            echo "Gravitee Containers :  Docker tags, Releasing Docker images as NON-latest"
                        fi
                    fi

                    docker images
      - run:
          name: "Docker Tests: Gravitee APIM Containers Community Edition"
          command: |
                    pwd
                    ls -allh
                    echo "Gravitee Containers :  Testing the Docker image before pushing it"
                    echo "No tests implemented yet."
      - gravitee/docker_login:
          secrethub_org: << pipeline.parameters.secrethub_org >>
          secrethub_repo: << pipeline.parameters.secrethub_repo >>
      - run:
          name: "Docker push: Gravitee APIM Containers Community Edition"
          command: |
                    echo "Gravitee Containers : Docker push"
                    export GRAVITEEIO_VERSION_MAJOR=$(echo "${GRAVITEEIO_VERSION}" | awk -F '.' '{print $1}')
                    export GRAVITEEIO_VERSION_MINOR=$(echo "${GRAVITEEIO_VERSION}" | awk -F '.' '{print $2}')
                    export GRAVITEEIO_VERSION_PATCH=$(echo "${GRAVITEEIO_VERSION}" | awk -F '.' '{print $3}')
                    docker images
                    if [ "$DRY_RUN" == "true" ]; then
                      echo "Skipped docker push in dry run mode"
                      exit 0
                    fi;
                    export DOCKER_FULL_TAG="${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}.${GRAVITEEIO_VERSION_PATCH}"


                    export DOCKER_IMAGE_NAME="graviteeio/gateway"
                    docker push ${DOCKER_IMAGE_NAME}:${DOCKER_FULL_TAG}
                    if [ "$TAG_LATEST" == "true" ]; then
                        echo "Gravitee Containers :  Docker tags, Releasing Docker images as latest"
                        docker push ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}
                        docker push ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}
                        docker push ${DOCKER_IMAGE_NAME}:latest
                    else
                        if [ "$TAG_LATEST_SUPPORT" == "true" ]; then
                            echo "Gravitee Containers :  Docker tags, Releasing Docker images as latest support"
                            docker push ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}
                        else
                            echo "Gravitee Containers :  Docker tags, Releasing Docker images as NON-latest"
                        fi
                    fi

                    export DOCKER_IMAGE_NAME="graviteeio/management-api"
                    docker push ${DOCKER_IMAGE_NAME}:${DOCKER_FULL_TAG}
                    if [ "$TAG_LATEST" == "true" ]; then
                        echo "Gravitee Containers :  Docker tags, Releasing Docker images as latest"
                        docker push ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}
                        docker push ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}
                        docker push ${DOCKER_IMAGE_NAME}:latest
                    else
                        if [ "$TAG_LATEST_SUPPORT" == "true" ]; then
                            echo "Gravitee Containers :  Docker tags, Releasing Docker images as latest support"
                            docker push ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}
                        else
                            echo "Gravitee Containers :  Docker tags, Releasing Docker images as NON-latest"
                        fi
                    fi

                    export DOCKER_IMAGE_NAME="graviteeio/management-ui"
                    docker push ${DOCKER_IMAGE_NAME}:${DOCKER_FULL_TAG}
                    if [ "$TAG_LATEST" == "true" ]; then
                        echo "Gravitee Containers :  Docker tags, Releasing Docker images as latest"
                        docker push ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}
                        docker push ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}
                        docker push ${DOCKER_IMAGE_NAME}:latest
                    else
                        if [ "$TAG_LATEST_SUPPORT" == "true" ]; then
                            echo "Gravitee Containers :  Docker tags, Releasing Docker images as latest support"
                            docker push ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}
                        else
                            echo "Gravitee Containers :  Docker tags, Releasing Docker images as NON-latest"
                        fi
                    fi
      - run:
          name: "Docker build: Gravitee APIM Containers Entreprise Edition"
          command: |
                    pwd
                    ls -allh
                    echo "Gravitee Containers :  Docker build"
                    export GRAVITEEIO_VERSION_MAJOR=$(echo "${GRAVITEEIO_VERSION}" | awk -F '.' '{print $1}')
                    export GRAVITEEIO_VERSION_MINOR=$(echo "${GRAVITEEIO_VERSION}" | awk -F '.' '{print $2}')
                    export GRAVITEEIO_VERSION_PATCH=$(echo "${GRAVITEEIO_VERSION}" | awk -F '.' '{print $3}')
                    export DOCKER_FULL_TAG="${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}.${GRAVITEEIO_VERSION_PATCH}-ee"
                    export DOCKER_BUILD_ARGS="--build-arg GRAVITEEIO_VERSION=${GRAVITEEIO_VERSION}"

                    echo " Docker build: Gravitee APIM Gateway version [${GRAVITEEIO_VERSION}]"
                    export DOCKER_IMAGE_NAME="graviteeio/gateway"
                    echo "docker build ${DOCKER_BUILD_ARGS} -t ${DOCKER_IMAGE_NAME}:${DOCKER_FULL_TAG} enterprise/apim/1.x/gateway"
                    docker build ${DOCKER_BUILD_ARGS} -t ${DOCKER_IMAGE_NAME}:${DOCKER_FULL_TAG} enterprise/apim/1.x/gateway

                    echo " Docker build: Gravitee APIM Management API version [${GRAVITEEIO_VERSION}]"
                    export DOCKER_IMAGE_NAME="graviteeio/management-api"
                    echo "docker build ${DOCKER_BUILD_ARGS} -t ${DOCKER_IMAGE_NAME}:${DOCKER_FULL_TAG} enterprise/apim/1.x/management-api"
                    docker build ${DOCKER_BUILD_ARGS} -t ${DOCKER_IMAGE_NAME}:${DOCKER_FULL_TAG} enterprise/apim/1.x/management-api

                    echo " Docker build: Gravitee APIM Management UI version [${GRAVITEEIO_VERSION}]"
                    export DOCKER_IMAGE_NAME="graviteeio/management-ui"
                    echo "docker build ${DOCKER_BUILD_ARGS} -t ${DOCKER_IMAGE_NAME}:${DOCKER_FULL_TAG} enterprise/apim/1.x/management-ui"
                    echo "Checking prensence of [Dockerfile] in folder [./enterprise/apim/1.x/management-ui]"
                    docker build ${DOCKER_BUILD_ARGS} -t ${DOCKER_IMAGE_NAME}:${DOCKER_FULL_TAG} enterprise/apim/1.x/management-ui

      - run:
          name: "Docker tags: Gravitee APIM Containers Entreprise Edition"
          command: |
                    pwd
                    ls -allh
                    export GRAVITEEIO_VERSION_MAJOR=$(echo "${GRAVITEEIO_VERSION}" | awk -F '.' '{print $1}')
                    export GRAVITEEIO_VERSION_MINOR=$(echo "${GRAVITEEIO_VERSION}" | awk -F '.' '{print $2}')
                    export GRAVITEEIO_VERSION_PATCH=$(echo "${GRAVITEEIO_VERSION}" | awk -F '.' '{print $3}')
                    export DOCKER_FULL_TAG="${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}.${GRAVITEEIO_VERSION_PATCH}-ee"

                    export DOCKER_IMAGE_NAME="graviteeio/gateway"
                    if [ "$TAG_LATEST" == "true" ]; then
                        echo "Gravitee Containers :  Docker tags, Releasing Docker images as latest"
                        docker tag ${DOCKER_IMAGE_NAME}:${DOCKER_FULL_TAG} ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}-ee
                        # docker push ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}-ee
                        docker tag ${DOCKER_IMAGE_NAME}:${DOCKER_FULL_TAG} ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}-ee
                        # docker push ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}-ee
                    else
                        if [ "$TAG_LATEST_SUPPORT" == "true" ]; then
                            echo "Gravitee Containers :  Docker tags, Releasing Docker images as latest support"
                            docker tag ${DOCKER_IMAGE_NAME}:${DOCKER_FULL_TAG} ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}-ee
                            # docker push ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}-ee
                        else
                            echo "Gravitee Containers :  Docker tags, Releasing Docker images as NON-latest"
                        fi
                    fi
                    export DOCKER_IMAGE_NAME="graviteeio/management-api"
                    if [ "$TAG_LATEST" == "true" ]; then
                        echo "Gravitee Containers :  Docker tags, Releasing Docker images as latest"
                        docker tag ${DOCKER_IMAGE_NAME}:${DOCKER_FULL_TAG} ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}-ee
                        # docker push ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}-ee
                        docker tag ${DOCKER_IMAGE_NAME}:${DOCKER_FULL_TAG} ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}-ee
                        # docker push ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}-ee
                    else
                        if [ "$TAG_LATEST_SUPPORT" == "true" ]; then
                            echo "Gravitee Containers :  Docker tags, Releasing Docker images as latest support"
                            docker tag ${DOCKER_IMAGE_NAME}:${DOCKER_FULL_TAG} ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}-ee
                            # docker push ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}-ee
                        else
                            echo "Gravitee Containers :  Docker tags, Releasing Docker images as NON-latest"
                        fi
                    fi
                    export DOCKER_IMAGE_NAME="graviteeio/management-ui"
                    if [ "$TAG_LATEST" == "true" ]; then
                        echo "Gravitee Containers :  Docker tags, Releasing Docker images as latest"
                        docker tag ${DOCKER_IMAGE_NAME}:${DOCKER_FULL_TAG} ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}-ee
                        # docker push ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}-ee
                        docker tag ${DOCKER_IMAGE_NAME}:${DOCKER_FULL_TAG} ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}-ee
                        # docker push ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}-ee
                    else
                        if [ "$TAG_LATEST_SUPPORT" == "true" ]; then
                            echo "Gravitee Containers :  Docker tags, Releasing Docker images as latest support"
                            docker tag ${DOCKER_IMAGE_NAME}:${DOCKER_FULL_TAG} ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}-ee
                            # docker push ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}-ee
                        else
                            echo "Gravitee Containers :  Docker tags, Releasing Docker images as NON-latest"
                        fi
                    fi

                    docker images
      - run:
          name: "Docker tests: Gravitee APIM Containers Entreprise Edition"
          command: |
                    pwd
                    ls -allh
                    echo "Gravitee Containers :  Testing the Docker image before pushing it"
                    echo "No tests implemented yet."
      - gravitee/docker_login:
          secrethub_org: << pipeline.parameters.secrethub_org >>
          secrethub_repo: << pipeline.parameters.secrethub_repo >>
      - run:
          name: "Docker push: Gravitee APIM Containers Entreprise Edition"
          command: |
                    echo "Gravitee Containers : Docker push"
                    export GRAVITEEIO_VERSION_MAJOR=$(echo "${GRAVITEEIO_VERSION}" | awk -F '.' '{print $1}')
                    export GRAVITEEIO_VERSION_MINOR=$(echo "${GRAVITEEIO_VERSION}" | awk -F '.' '{print $2}')
                    export GRAVITEEIO_VERSION_PATCH=$(echo "${GRAVITEEIO_VERSION}" | awk -F '.' '{print $3}')
                    docker images
                    if [ "$DRY_RUN" == "true" ]; then
                      echo "Skipped docker push in dry run mode"
                      exit 0
                    fi;
                    export DOCKER_FULL_TAG="${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}.${GRAVITEEIO_VERSION_PATCH}-ee"


                    export DOCKER_IMAGE_NAME="graviteeio/gateway"
                    docker push ${DOCKER_IMAGE_NAME}:${DOCKER_FULL_TAG}
                    if [ "$TAG_LATEST" == "true" ]; then
                        echo "Gravitee Containers :  Docker tags, Releasing Docker images as latest"
                        docker push ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}-ee
                        docker push ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}-ee
                    else
                        if [ "$TAG_LATEST_SUPPORT" == "true" ]; then
                            echo "Gravitee Containers :  Docker tags, Releasing Docker images as latest support"
                            docker push ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}-ee
                        else
                            echo "Gravitee Containers :  Docker tags, Releasing Docker images as NON-latest"
                        fi
                    fi

                    export DOCKER_IMAGE_NAME="graviteeio/management-api"
                    docker push ${DOCKER_IMAGE_NAME}:${DOCKER_FULL_TAG}
                    if [ "$TAG_LATEST" == "true" ]; then
                        echo "Gravitee Containers :  Docker tags, Releasing Docker images as latest"
                        docker push ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}-ee
                        docker push ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}-ee
                    else
                        if [ "$TAG_LATEST_SUPPORT" == "true" ]; then
                            echo "Gravitee Containers :  Docker tags, Releasing Docker images as latest support"
                            docker push ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}-ee
                        else
                            echo "Gravitee Containers :  Docker tags, Releasing Docker images as NON-latest"
                        fi
                    fi

                    export DOCKER_IMAGE_NAME="graviteeio/management-ui"
                    docker push ${DOCKER_IMAGE_NAME}:${DOCKER_FULL_TAG}
                    if [ "$TAG_LATEST" == "true" ]; then
                        echo "Gravitee Containers :  Docker tags, Releasing Docker images as latest"
                        docker push ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}-ee
                        docker push ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}-ee
                    else
                        if [ "$TAG_LATEST_SUPPORT" == "true" ]; then
                            echo "Gravitee Containers :  Docker tags, Releasing Docker images as latest support"
                            docker push ${DOCKER_IMAGE_NAME}:${GRAVITEEIO_VERSION_MAJOR}.${GRAVITEEIO_VERSION_MINOR}-ee
                        else
                            echo "Gravitee Containers :  Docker tags, Releasing Docker images as NON-latest"
                        fi
                    fi

  # Gravitee AM Container Images
  build_n_push_am_ce_job:
    machine:
      image: 'ubuntu-1604:201903-01'
      resource_class: large
      docker_layer_caching: true    # default - false # requires a Circle CI plan that includes [Docker layer caching feature]
    environment:
      DRY_RUN: << pipeline.parameters.dry_run >>
      TAG_LATEST: << pipeline.parameters.tag_latest >>
      TAG_LATEST_SUPPORT: << pipeline.parameters.tag_latest_support >>
      PRUNE_IT_ALL: << pipeline.parameters.prune >>
      GRAVITEEIO_VERSION: << pipeline.parameters.graviteeio_version >>
      SECRETHUB_ORG: << pipeline.parameters.secrethub_org >>
      SECRETHUB_REPO: << pipeline.parameters.secrethub_repo >>
      GIO_PRODUCT: << pipeline.parameters.gio_product >>
    steps:
      - run:
          name: "Checking environment : Compare [GRAVITEEIO_VERSION] and [GIO_PRODUCT]"
          command: |
                    echo "Docker version is : "
                    docker version
                    export GRAVITEEIO_VERSION_MAJOR=$(echo "${GRAVITEEIO_VERSION}" | awk -F '.' '{print $1}')
                    export GRAVITEEIO_VERSION_MINOR=$(echo "${GRAVITEEIO_VERSION}" | awk -F '.' '{print $2}')
                    export GRAVITEEIO_VERSION_PATCH=$(echo "${GRAVITEEIO_VERSION}" | awk -F '.' '{print $3}')
                    echo "TAG_LATEST=[${TAG_LATEST}]"
                    echo "SECRETHUB_ORG=[${SECRETHUB_ORG}]"
                    echo "SECRETHUB_REPO=[${SECRETHUB_REPO}]"
                    echo "GRAVITEEIO_VERSION=[${GRAVITEEIO_VERSION}]"
                    echo "GRAVITEEIO_VERSION_MAJOR=[${GRAVITEEIO_VERSION_MAJOR}]"
                    echo "GRAVITEEIO_VERSION_MINOR=[${GRAVITEEIO_VERSION_MINOR}]"
                    echo "GRAVITEEIO_VERSION_PATCH=[${GRAVITEEIO_VERSION_PATCH}]"
                    if ! [ "${GRAVITEEIO_VERSION_MAJOR}" == "3" ]; then
                      if ! [ "${GRAVITEEIO_VERSION_MAJOR}" == "2" ]; then
                        echo "The [${GRAVITEEIO_VERSION}] Gravitee AM Release Version is of a Gravitee AM Generation not supported yet in this Pipeline"
                      fi;
                    fi;
                    if [ "${GIO_PRODUCT}" == "am_v2" ]; then
                      if ! [ "${GRAVITEEIO_VERSION_MAJOR}" == "2" ]; then
                        echo "The [${GRAVITEEIO_VERSION}] Gravitee AM Release Version is not a Gravitee AM V2 Generation, but "
                        echo "you invoked this pipeline for with Pipeline parameter [gio_product='${GIO_PRODUCT}']"
                        exit 4
                      fi;
                    fi;
                    if [ "${GIO_PRODUCT}" == "am_v3" ]; then
                      if ! [ "${GRAVITEEIO_VERSION_MAJOR}" == "3" ]; then
                        echo "The [${GRAVITEEIO_VERSION}] Gravitee AM Release Version is not a Gravitee AM V3 Generation, but "
                        echo "you invoked this pipeline for with Pipeline parameter [gio_product='${GIO_PRODUCT}']"
                        exit 4
                      fi;
                    fi;

      - checkout
      - secrethub/install
      - gravitee/git_config:
          secrethub_org: << pipeline.parameters.secrethub_org >>
          secrethub_repo: << pipeline.parameters.secrethub_repo >>
      - run:
          name: "Testing the Git Config"
          command: |
                    echo "Docker version is : "
                    docker version
                    export GRAVITEEIO_VERSION_MAJOR=$(echo "${GRAVITEEIO_VERSION}" | awk -F '.' '{print $1}')
                    export GRAVITEEIO_VERSION_MINOR=$(echo "${GRAVITEEIO_VERSION}" | awk -F '.' '{print $2}')
                    export GRAVITEEIO_VERSION_PATCH=$(echo "${GRAVITEEIO_VERSION}" | awk -F '.' '{print $3}')
                    echo "TAG_LATEST=[${TAG_LATEST}]"
                    echo "SECRETHUB_ORG=[${SECRETHUB_ORG}]"
                    echo "SECRETHUB_REPO=[${SECRETHUB_REPO}]"
                    echo "GRAVITEEIO_VERSION=[${GRAVITEEIO_VERSION}]"
                    echo "GRAVITEEIO_VERSION_MAJOR=[${GRAVITEEIO_VERSION_MAJOR}]"
                    echo "GRAVITEEIO_VERSION_MINOR=[${GRAVITEEIO_VERSION_MINOR}]"
                    echo "GRAVITEEIO_VERSION_PATCH=[${GRAVITEEIO_VERSION_PATCH}]"
                    # ---
                    # Testing if the git config properly configured SSH Agent
                    echo "# ==> Testing if the git config properly configured SSH Agent"
                    ssh -T git@github.com || true
      - run:
          name: "Prune"
          command: |
                    if [ "$PRUNE_IT_ALL" == "true" ]; then
                      echo "Pruning all Docker images "
                      docker system prune -f --all
                    else
                      echo "Skipped Pruning all Docker images "
                    fi;
      - run:
          name: "Build Docker Images: Gravitee AM Community Edition"
          command: |
            pwd
            ls -allh
            export OPS_HOME=$(pwd)
            export RELEASE_VERSION=$GRAVITEEIO_VERSION
            export RELEASE_VERSION_MAJOR=$(echo "$GRAVITEEIO_VERSION" | awk -F '.' '{print $1}')
            export RELEASE_VERSION_MINOR=$(echo "$GRAVITEEIO_VERSION" | awk -F '.' '{print $2}')
            export RELEASE_VERSION_PATCH=$(echo "$GRAVITEEIO_VERSION" | awk -F '.' '{print $3}')
            echo " [--------------------------------------------------------------------------------] "
            echo " [--------------------------------------------------------------------------------] "
            echo " [--------------------------------------------------------------------------------] "
            echo " [--------------------------------------------------------------------------------] "
            echo "                            FOR THE DOCKER RELEASE : "
            echo "                                "
            echo " [--------------------------------------------------------------------------------] "
            echo "      RELEASE_VERSION=[${RELEASE_VERSION}]"
            echo "      RELEASE_VERSION_MAJOR=[${RELEASE_VERSION_MAJOR}]"
            echo "      RELEASE_VERSION_MINOR=[${RELEASE_VERSION_MINOR}]"
            echo "      RELEASE_VERSION_PATCH=[${RELEASE_VERSION_PATCH}]"
            echo " [--------------------------------------------------------------------------------] "
            echo " [--------------------------------------------------------------------------------] "
            echo " [--------------------------------------------------------------------------------] "
            #
            # Secure docker images tagging
            if ! [ "${RELEASE_VERSION}" == "${RELEASE_VERSION_MAJOR}.${RELEASE_VERSION_MINOR}.${RELEASE_VERSION_PATCH}" ]; then
              echo "[${RELEASE_VERSION}] and [${RELEASE_VERSION_MAJOR}.${RELEASE_VERSION_MINOR}.${RELEASE_VERSION_PATCH}] should be equal, and are not, stopping pipeline, debug and check pipeline."
              exit 3
            fi;
            echo " Docker build: Gravitee Access Management version [${GRAVITEEIO_VERSION}]"
            export DOCKER_WORKSHOP=$(mktemp -d -t "access_management-XXXXXXXXXX")
            export GIT_SSH_URI=git@github.com:gravitee-io/graviteeio-access-management.git
            cd ${OPS_HOME}
            git clone ${GIT_SSH_URI} ${DOCKER_WORKSHOP}
            cd ${DOCKER_WORKSHOP}
            git checkout "${GRAVITEEIO_VERSION}"
            cd ${OPS_HOME}
            echo " [++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++] "
            echo " [--------------------------------------------------------------------------------] "
            echo "                            DOCKER BUILD GRAVITEE AM CONTAINER IMAGES : "
            echo " [--------------------------------------------------------------------------------] "
            echo " [++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++] "
            echo "                            DOCKER BUILD GRAVITEE AM GATEWAY : "
            echo " [--------------------------------------------------------------------------------] "
            docker build -f ${DOCKER_WORKSHOP}/docker/gateway/Dockerfile --build-arg GRAVITEEAM_VERSION=${RELEASE_VERSION} -t graviteeio/am-gateway:${RELEASE_VERSION} ${DOCKER_WORKSHOP}/docker/gateway/
            docker tag graviteeio/am-gateway:${RELEASE_VERSION} graviteeio/am-gateway:latest
            docker tag graviteeio/am-gateway:${RELEASE_VERSION} graviteeio/am-gateway:"${RELEASE_VERSION_MAJOR}"
            docker tag graviteeio/am-gateway:${RELEASE_VERSION} graviteeio/am-gateway:"${RELEASE_VERSION_MAJOR}.${RELEASE_VERSION_MINOR}"
            docker images
            echo " [--------------------------------------------------------------------------------] "
            echo "                            DOCKER BUILD GRAVITEE AM MANAGEMENT API : "
            echo " [--------------------------------------------------------------------------------] "
            docker build -f ${DOCKER_WORKSHOP}/docker/management-api/Dockerfile --build-arg GRAVITEEAM_VERSION=${RELEASE_VERSION} -t graviteeio/am-management-api:${RELEASE_VERSION} ${DOCKER_WORKSHOP}/docker/management-api/
            docker tag graviteeio/am-management-api:${RELEASE_VERSION} graviteeio/am-management-api:latest
            docker tag graviteeio/am-management-api:${RELEASE_VERSION} graviteeio/am-management-api:"${RELEASE_VERSION_MAJOR}"
            docker tag graviteeio/am-management-api:${RELEASE_VERSION} graviteeio/am-management-api:"${RELEASE_VERSION_MAJOR}.${RELEASE_VERSION_MINOR}"
            docker images
            echo " [--------------------------------------------------------------------------------] "
            echo "                            DOCKER BUILD GRAVITEE AM MANAGEMENT UI : "
            echo " [--------------------------------------------------------------------------------] "
            docker build -f ${DOCKER_WORKSHOP}/docker/management-ui/Dockerfile --build-arg GRAVITEEAM_VERSION=${RELEASE_VERSION} -t graviteeio/am-management-ui:${RELEASE_VERSION} ${DOCKER_WORKSHOP}/docker/management-ui/
            docker tag graviteeio/am-management-ui:${RELEASE_VERSION} graviteeio/am-management-ui:latest
            docker tag graviteeio/am-management-ui:${RELEASE_VERSION} graviteeio/am-management-ui:"${RELEASE_VERSION_MAJOR}"
            docker tag graviteeio/am-management-ui:${RELEASE_VERSION} graviteeio/am-management-ui:"${RELEASE_VERSION_MAJOR}.${RELEASE_VERSION_MINOR}"
            docker images

      - run:
          name: "Docker tests: Gravitee AM Community Edition"
          command: |
                    pwd
                    ls -allh
                    echo "Gravitee Containers :  Testing the Docker image before pushing it"
                    echo "No tests implemented yet."
      - gravitee/docker_login:
          secrethub_org: << pipeline.parameters.secrethub_org >>
          secrethub_repo: << pipeline.parameters.secrethub_repo >>
      - run:
          name: "Publish Docker Image to Docker Hub: Gravitee AM Community Edition"
          command: |
            pwd
            ls -allh
            export OPS_HOME=$(pwd)
            export RELEASE_VERSION=$GRAVITEEIO_VERSION
            export RELEASE_VERSION_MAJOR=$(echo "$GRAVITEEIO_VERSION" | awk -F '.' '{print $1}')
            export RELEASE_VERSION_MINOR=$(echo "$GRAVITEEIO_VERSION" | awk -F '.' '{print $2}')
            export RELEASE_VERSION_PATCH=$(echo "$GRAVITEEIO_VERSION" | awk -F '.' '{print $3}')
            echo " [--------------------------------------------------------------------------------] "
            echo " [--------------------------------------------------------------------------------] "
            echo " [--------------------------------------------------------------------------------] "
            echo " [--------------------------------------------------------------------------------] "
            echo "                            FOR THE DOCKER RELEASE : "
            echo "                                "
            echo " [--------------------------------------------------------------------------------] "
            echo "      RELEASE_VERSION=[${RELEASE_VERSION}]"
            echo "      RELEASE_VERSION_MAJOR=[${RELEASE_VERSION_MAJOR}]"
            echo "      RELEASE_VERSION_MINOR=[${RELEASE_VERSION_MINOR}]"
            echo "      RELEASE_VERSION_PATCH=[${RELEASE_VERSION_PATCH}]"
            echo " [--------------------------------------------------------------------------------] "
            echo " [--------------------------------------------------------------------------------] "
            echo " [--------------------------------------------------------------------------------] "
            #
            # Secure docker images tagging
            if ! [ "${RELEASE_VERSION}" == "${RELEASE_VERSION_MAJOR}.${RELEASE_VERSION_MINOR}.${RELEASE_VERSION_PATCH}" ]; then
              echo "[${RELEASE_VERSION}] and [${RELEASE_VERSION_MAJOR}.${RELEASE_VERSION_MINOR}.${RELEASE_VERSION_PATCH}] should be equal, and are not, stopping pipeline, debug and check pipeline."
              exit 3
            fi;
            docker images
            echo " [++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++] "
            echo " [--------------------------------------------------------------------------------] "
            echo "                            DOCKER PUSH GRAVITEE AM CONTAINER IMAGES : "
            echo " [--------------------------------------------------------------------------------] "
            echo " [++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++] "

            echo " [--------------------------------------------------------------------------------] "
            echo "                            DOCKER PUSH GRAVITEE AM GATEWAY : "
            echo " [--------------------------------------------------------------------------------] "
            if [ "${DRY_RUN}" == "false" ]; then
              # --->>> NO IT IS NOT A DRY RUN
              echo "# --->>> NO IT IS NOT A DRY RUN : GO DOCKER PUSH"
              if [ "${TAG_LATEST}" == "true" ]; then
                # --->>> NO IT IS NOT A DRY RUN
                echo "# --->>> NO IT IS NOT A DRY RUN : THIS IS A LATEST RELEASE"
                docker push graviteeio/am-gateway:latest
                docker push graviteeio/am-gateway:"${RELEASE_VERSION_MAJOR}"
                docker push graviteeio/am-gateway:"${RELEASE_VERSION_MAJOR}.${RELEASE_VERSION_MINOR}"
                docker push graviteeio/am-gateway:${RELEASE_VERSION}
              else
                echo "# --->>> THIS IS A DRY RUN : THIS IS NOT A LATEST RELEASE, SO WILL DOCKER PUSH ONLY [${RELEASE_VERSION}]=[${RELEASE_VERSION_MAJOR}.${RELEASE_VERSION_MINOR}.${RELEASE_VERSION_PATCH}]"
                docker push graviteeio/am-gateway:"${RELEASE_VERSION}"
                if [ "$TAG_LATEST_SUPPORT" == "true" ]; then
                    echo "Gravitee Containers :  Docker tags, Releasing Docker images as latest support"
                    docker push graviteeio/am-gateway:"${RELEASE_VERSION_MAJOR}.${RELEASE_VERSION_MINOR}"
                else
                    echo "Gravitee Containers :  Docker tags, Releasing Docker images as NON-latest"
                fi
              fi;
            else
              echo "# --->>> THIS IS A DRY RUN : SKIPPING DOCKER PUSH"
            fi;
            echo " [--------------------------------------------------------------------------------] "
            echo "                            DOCKER PUSH GRAVITEE AM MANAGEMENT API : "
            echo " [--------------------------------------------------------------------------------] "
            if [ "${DRY_RUN}" == "false" ]; then
              # --->>> NO IT IS NOT A DRY RUN
              echo "# --->>> NO IT IS NOT A DRY RUN : GO DOCKER PUSH"
              if [ "${TAG_LATEST}" == "true" ]; then
                # --->>> NO IT IS NOT A DRY RUN
                echo "# --->>> NO IT IS NOT A DRY RUN : THIS IS A LATEST RELEASE"
                docker push graviteeio/am-management-api:latest
                docker push graviteeio/am-management-api:"${RELEASE_VERSION_MAJOR}"
                docker push graviteeio/am-management-api:"${RELEASE_VERSION_MAJOR}.${RELEASE_VERSION_MINOR}"
                docker push graviteeio/am-management-api:${RELEASE_VERSION}
              else
                echo "# --->>> THIS IS A DRY RUN : THIS IS NOT A LATEST RELEASE, SO WILL DOCKER PUSH ONLY [${RELEASE_VERSION}]=[${RELEASE_VERSION_MAJOR}.${RELEASE_VERSION_MINOR}.${RELEASE_VERSION_PATCH}]"
                docker push graviteeio/am-management-api:"${RELEASE_VERSION}"
                if [ "$TAG_LATEST_SUPPORT" == "true" ]; then
                    echo "Gravitee Containers :  Docker tags, Releasing Docker images as latest support"
                    docker push graviteeio/am-management-api:"${RELEASE_VERSION_MAJOR}.${RELEASE_VERSION_MINOR}"
                else
                    echo "Gravitee Containers :  Docker tags, Releasing Docker images as NON-latest"
                fi
              fi;
            else
              echo "# --->>> THIS IS A DRY RUN : SKIPPING DOCKER PUSH"
            fi;
            echo " [--------------------------------------------------------------------------------] "
            echo "                            DOCKER PUSH GRAVITEE AM MANAGEMENT UI : "
            echo " [--------------------------------------------------------------------------------] "

            if [ "${DRY_RUN}" == "false" ]; then
              # --->>> NO IT IS NOT A DRY RUN
              echo "# --->>> NO IT IS NOT A DRY RUN : GO DOCKER PUSH"
              if [ "${TAG_LATEST}" == "true" ]; then
                # --->>> NO IT IS NOT A DRY RUN
                echo "# --->>> NO IT IS NOT A DRY RUN : THIS IS A LATEST RELEASE"
                docker push graviteeio/am-management-ui:latest
                docker push graviteeio/am-management-ui:"${RELEASE_VERSION_MAJOR}"
                docker push graviteeio/am-management-ui:"${RELEASE_VERSION_MAJOR}.${RELEASE_VERSION_MINOR}"
                docker push graviteeio/am-management-ui:${RELEASE_VERSION}
              else
                echo "# --->>> THIS IS A DRY RUN : THIS IS NOT A LATEST RELEASE, SO WILL DOCKER PUSH ONLY [${RELEASE_VERSION}]=[${RELEASE_VERSION_MAJOR}.${RELEASE_VERSION_MINOR}.${RELEASE_VERSION_PATCH}]"
                docker push graviteeio/am-management-ui:"${RELEASE_VERSION}"
                if [ "$TAG_LATEST_SUPPORT" == "true" ]; then
                    echo "Gravitee Containers :  Docker tags, Releasing Docker images as latest support"
                    docker push graviteeio/am-management-ui:"${RELEASE_VERSION_MAJOR}.${RELEASE_VERSION_MINOR}"
                else
                    echo "Gravitee Containers :  Docker tags, Releasing Docker images as NON-latest"
                fi
              fi;
            else
              echo "# --->>> THIS IS A DRY RUN : SKIPPING DOCKER PUSH"
            fi;

  # ---
  # Builds all the container images : Gravitee AM EE v3
  #  - graviteeio/am-management-ui
  #  - graviteeio/am-gateway
  #  - graviteeio/am-management-api
  # ---
  build_n_push_am_ee_v3_gateway_job:
    machine:
      image: 'ubuntu-1604:201903-01'
      resource_class: large
      docker_layer_caching: true    # default - false # requires a Circle CI plan that includes [Docker layer caching feature]
    environment:
      DRY_RUN: << pipeline.parameters.dry_run >>
      TAG_LATEST: << pipeline.parameters.tag_latest >>
      TAG_LATEST_SUPPORT: << pipeline.parameters.tag_latest_support >>
      PRUNE_IT_ALL: << pipeline.parameters.prune >>
      GRAVITEEIO_VERSION: << pipeline.parameters.graviteeio_version >>
      SECRETHUB_ORG: << pipeline.parameters.secrethub_org >>
      SECRETHUB_REPO: << pipeline.parameters.secrethub_repo >>
    steps:
      - checkout
      - secrethub/install
      - run:
          name: "Gravitee AM EE v3 Gateway: Check Environment"
          command: |
            pwd
            ls -allh
            export OPS_HOME=$(pwd)
            export RELEASE_VERSION=$GRAVITEEIO_VERSION
            export RELEASE_VERSION_MAJOR=$(echo "$GRAVITEEIO_VERSION" | awk -F '.' '{print $1}')
            export RELEASE_VERSION_MINOR=$(echo "$GRAVITEEIO_VERSION" | awk -F '.' '{print $2}')
            export RELEASE_VERSION_PATCH=$(echo "$GRAVITEEIO_VERSION" | awk -F '.' '{print $3}')
            echo " "
            echo " [--------------------------------------------------------------------------------] "
            echo " [--------------------------------------------------------------------------------] "
            echo " [--------------------------------------------------------------------------------] "
            echo " [--------------------------------------------------------------------------------] "
            echo "                            FOR THE DOCKER RELEASE : "
            echo "                                "
            echo " [--------------------------------------------------------------------------------] "
            echo "      RELEASE_VERSION=[${RELEASE_VERSION}]"
            echo "      RELEASE_VERSION_MAJOR=[${RELEASE_VERSION_MAJOR}]"
            echo "      RELEASE_VERSION_MINOR=[${RELEASE_VERSION_MINOR}]"
            echo "      RELEASE_VERSION_PATCH=[${RELEASE_VERSION_PATCH}]"
            echo " [--------------------------------------------------------------------------------] "
            echo " [--------------------------------------------------------------------------------] "
            echo " [--------------------------------------------------------------------------------] "
            if ! [ "${RELEASE_VERSION_MAJOR}" == "3" ]; then
              echo "The [${RELEASE_VERSION}] version is not a Gravitee V3 Generation version"
              exit 3
            fi;
      - run:
          name: "Prune"
          command: |
            if [ "$PRUNE_IT_ALL" == "true" ]; then
              echo "Pruning all Docker images"
              docker system prune -f --all
            else
              echo "Skipped Pruning all Docker images "
            fi;
      - run:
          name: "Gravitee AM EE v3 Gateway: Build Container Image"
          command: |
            export RELEASE_VERSION=$GRAVITEEIO_VERSION
            export RELEASE_VERSION_MAJOR=$(echo "$GRAVITEEIO_VERSION" | awk -F '.' '{print $1}')
            export RELEASE_VERSION_MINOR=$(echo "$GRAVITEEIO_VERSION" | awk -F '.' '{print $2}')
            export RELEASE_VERSION_PATCH=$(echo "$GRAVITEEIO_VERSION" | awk -F '.' '{print $3}')
            echo ""
            echo " [--------------------------------------------------------------------------------] "
            echo "                            DOCKER BUILD GRAVITEE AM GATEWAY : "
            echo " [--------------------------------------------------------------------------------] "
            docker build -f ./enterprise/am/3.x/gateway/Dockerfile --build-arg GRAVITEEIO_AM_VERSION=${RELEASE_VERSION} -t "graviteeio/am-gateway:${RELEASE_VERSION}-ee" ./enterprise/am/3.x/gateway/
            docker tag "graviteeio/am-gateway:${RELEASE_VERSION}-ee" "graviteeio/am-gateway:${RELEASE_VERSION_MAJOR}-ee"
            docker tag "graviteeio/am-gateway:${RELEASE_VERSION}-ee" "graviteeio/am-gateway:${RELEASE_VERSION_MAJOR}.${RELEASE_VERSION_MINOR}-ee"
            docker images
      - run:
          name: "Gravitee AM EE v3 Gateway: Test Container Image"
          command: |
            export RELEASE_VERSION=$GRAVITEEIO_VERSION
            export RELEASE_VERSION_MAJOR=$(echo "$GRAVITEEIO_VERSION" | awk -F '.' '{print $1}')
            export RELEASE_VERSION_MINOR=$(echo "$GRAVITEEIO_VERSION" | awk -F '.' '{print $2}')
            export RELEASE_VERSION_PATCH=$(echo "$GRAVITEEIO_VERSION" | awk -F '.' '{print $3}')
            echo ""
            echo " [--------------------------------------------------------------------------------] "
            echo "                            DOCKER IMAGE GRAVITEE AM MANAGEMENT API TEST : "
            echo " [--------------------------------------------------------------------------------] "
            docker run -itd --name am-gw-ee-test1 "graviteeio/am-gateway:${RELEASE_VERSION}-ee" sh
            echo "Runing test : is [./bin/gravitee] at the expected location ? (in ${GRAVITEEIO_HOME}/bin/gravitee)"
            docker exec -it am-gw-ee-test1 sh -c "pwd && echo \"value of GRAVITEEIO_HOME=[\${GRAVITEEIO_HOME}]\""
            docker exec -it am-gw-ee-test1 sh -c "pwd && ls -allh \${GRAVITEEIO_HOME} && ls -allh \${GRAVITEEIO_HOME}/bin && ls -allh \${GRAVITEEIO_HOME}/bin/gravitee"
            docker exec -it am-gw-ee-test1 sh -c "pwd && ls -allh && ls -allh ./bin && ls -allh ./bin/gravitee"
            docker stop am-gw-ee-test1 && docker rm am-gw-ee-test1
      - gravitee/docker_login:
          secrethub_org: << pipeline.parameters.secrethub_org >>
          secrethub_repo: << pipeline.parameters.secrethub_repo >>

      - run:
          name: "Gravitee AM EE v3 Gateway: Docker Push Container Image"
          command: |
            export RELEASE_VERSION=$GRAVITEEIO_VERSION
            export RELEASE_VERSION_MAJOR=$(echo "$GRAVITEEIO_VERSION" | awk -F '.' '{print $1}')
            export RELEASE_VERSION_MINOR=$(echo "$GRAVITEEIO_VERSION" | awk -F '.' '{print $2}')
            export RELEASE_VERSION_PATCH=$(echo "$GRAVITEEIO_VERSION" | awk -F '.' '{print $3}')
            if [ "${DRY_RUN}" == "false" ]; then
              # --->>> NO IT IS NOT A DRY RUN
              echo "# --->>> NO IT IS NOT A DRY RUN : GO DOCKER PUSH"
              if [ "${TAG_LATEST}" == "true" ]; then
                # --->>> NO IT IS NOT A DRY RUN
                echo "# --->>> THIS IS A LATEST RELEASE"
                docker push "graviteeio/am-gateway:${RELEASE_VERSION_MAJOR}-ee"
                docker push "graviteeio/am-gateway:${RELEASE_VERSION_MAJOR}.${RELEASE_VERSION_MINOR}-ee"
                docker push "graviteeio/am-gateway:${RELEASE_VERSION}-ee"
              else
                echo "# --->>> THIS IS NOT A LATEST RELEASE, SO WILL DOCKER PUSH ONLY [${RELEASE_VERSION}]=[${RELEASE_VERSION_MAJOR}.${RELEASE_VERSION_MINOR}.${RELEASE_VERSION_PATCH}]"
                docker push "graviteeio/am-gateway:${RELEASE_VERSION}-ee"
                if [ "$TAG_LATEST_SUPPORT" == "true" ]; then
                    echo "Gravitee Containers :  Docker tags, Releasing Docker images as latest support"
                    docker push "graviteeio/am-gateway:${RELEASE_VERSION_MAJOR}.${RELEASE_VERSION_MINOR}-ee"
                else
                    echo "Gravitee Containers :  Docker tags, Releasing Docker images as NON-latest"
                fi
              fi;
            else
              echo "# --->>> THIS IS A DRY RUN : SKIPPING DOCKER PUSH"
            fi;

  build_n_push_am_ee_v3_api_job:
    machine:
      image: 'ubuntu-1604:201903-01'
      resource_class: large
      docker_layer_caching: true    # default - false # requires a Circle CI plan that includes [Docker layer caching feature]
    environment:
      DRY_RUN: << pipeline.parameters.dry_run >>
      TAG_LATEST: << pipeline.parameters.tag_latest >>
      TAG_LATEST_SUPPORT: << pipeline.parameters.tag_latest_support >>
      PRUNE_IT_ALL: << pipeline.parameters.prune >>
      GRAVITEEIO_VERSION: << pipeline.parameters.graviteeio_version >>
      SECRETHUB_ORG: << pipeline.parameters.secrethub_org >>
      SECRETHUB_REPO: << pipeline.parameters.secrethub_repo >>
    steps:
      - checkout
      - secrethub/install
      - run:
          name: "Gravitee AM EE v3 Management API: Check Environment"
          command: |
            pwd
            ls -allh
            export OPS_HOME=$(pwd)
            export RELEASE_VERSION=$GRAVITEEIO_VERSION
            export RELEASE_VERSION_MAJOR=$(echo "$GRAVITEEIO_VERSION" | awk -F '.' '{print $1}')
            export RELEASE_VERSION_MINOR=$(echo "$GRAVITEEIO_VERSION" | awk -F '.' '{print $2}')
            export RELEASE_VERSION_PATCH=$(echo "$GRAVITEEIO_VERSION" | awk -F '.' '{print $3}')
            echo " "
            echo " [--------------------------------------------------------------------------------] "
            echo " [--------------------------------------------------------------------------------] "
            echo " [--------------------------------------------------------------------------------] "
            echo " [--------------------------------------------------------------------------------] "
            echo "                            FOR THE DOCKER RELEASE : "
            echo "                                "
            echo " [--------------------------------------------------------------------------------] "
            echo "      RELEASE_VERSION=[${RELEASE_VERSION}]"
            echo "      RELEASE_VERSION_MAJOR=[${RELEASE_VERSION_MAJOR}]"
            echo "      RELEASE_VERSION_MINOR=[${RELEASE_VERSION_MINOR}]"
            echo "      RELEASE_VERSION_PATCH=[${RELEASE_VERSION_PATCH}]"
            echo " [--------------------------------------------------------------------------------] "
            echo " [--------------------------------------------------------------------------------] "
            echo " [--------------------------------------------------------------------------------] "
            if ! [ "${RELEASE_VERSION_MAJOR}" == "3" ]; then
              echo "The [${RELEASE_VERSION}] version is not a Gravitee V3 Generation version"
              exit 3
            fi;
      - run:
          name: "Prune"
          command: |
            if [ "$PRUNE_IT_ALL" == "true" ]; then
              echo "Pruning all Docker images"
              docker system prune -f --all
            else
              echo "Skipped Pruning all Docker images "
            fi;
      - run:
          name: "Gravitee AM EE v3 Management API: Build Container Image"
          command: |
            export RELEASE_VERSION=$GRAVITEEIO_VERSION
            export RELEASE_VERSION_MAJOR=$(echo "$GRAVITEEIO_VERSION" | awk -F '.' '{print $1}')
            export RELEASE_VERSION_MINOR=$(echo "$GRAVITEEIO_VERSION" | awk -F '.' '{print $2}')
            export RELEASE_VERSION_PATCH=$(echo "$GRAVITEEIO_VERSION" | awk -F '.' '{print $3}')
            echo ""
            echo " [--------------------------------------------------------------------------------] "
            echo "                            DOCKER BUILD GRAVITEE AM MANAGEMENT API : "
            echo " [--------------------------------------------------------------------------------] "
            docker build -f ./enterprise/am/3.x/management-api/Dockerfile --build-arg GRAVITEEIO_AM_VERSION=${RELEASE_VERSION} -t "graviteeio/am-management-api:${RELEASE_VERSION}-ee" ./enterprise/am/3.x/management-api/
            docker tag "graviteeio/am-management-api:${RELEASE_VERSION}-ee" "graviteeio/am-management-api:${RELEASE_VERSION_MAJOR}-ee"
            docker tag "graviteeio/am-management-api:${RELEASE_VERSION}-ee" "graviteeio/am-management-api:${RELEASE_VERSION_MAJOR}.${RELEASE_VERSION_MINOR}-ee"
            docker images
      - run:
          name: "Gravitee AM EE v3 Management API: Test Container Image"
          command: |
            export RELEASE_VERSION=$GRAVITEEIO_VERSION
            export RELEASE_VERSION_MAJOR=$(echo "$GRAVITEEIO_VERSION" | awk -F '.' '{print $1}')
            export RELEASE_VERSION_MINOR=$(echo "$GRAVITEEIO_VERSION" | awk -F '.' '{print $2}')
            export RELEASE_VERSION_PATCH=$(echo "$GRAVITEEIO_VERSION" | awk -F '.' '{print $3}')
            echo ""
            echo " [--------------------------------------------------------------------------------] "
            echo "                            DOCKER IMAGE GRAVITEE AM MANAGEMENT API TEST : "
            echo " [--------------------------------------------------------------------------------] "
            docker run -itd --name am-api-ee-test1 "graviteeio/am-management-api:${RELEASE_VERSION}-ee" sh
            echo "Runing test : is [./bin/gravitee] at the expected location ? (in ${GRAVITEEIO_HOME}/bin/gravitee)"
            docker exec -it am-api-ee-test1 sh -c "pwd && echo \"value of GRAVITEEIO_HOME=[\${GRAVITEEIO_HOME}]\""
            docker exec -it am-api-ee-test1 sh -c "pwd && ls -allh \${GRAVITEEIO_HOME} && ls -allh \${GRAVITEEIO_HOME}/bin && ls -allh \${GRAVITEEIO_HOME}/bin/gravitee"
            docker exec -it am-api-ee-test1 sh -c "pwd && ls -allh && ls -allh ./bin && ls -allh ./bin/gravitee"
            docker stop am-api-ee-test1 && docker rm  am-api-ee-test1
      - gravitee/docker_login:
          secrethub_org: << pipeline.parameters.secrethub_org >>
          secrethub_repo: << pipeline.parameters.secrethub_repo >>

      - run:
          name: "Gravitee AM EE v3 Management API: Docker Push Container Image"
          command: |
            export RELEASE_VERSION=$GRAVITEEIO_VERSION
            export RELEASE_VERSION_MAJOR=$(echo "$GRAVITEEIO_VERSION" | awk -F '.' '{print $1}')
            export RELEASE_VERSION_MINOR=$(echo "$GRAVITEEIO_VERSION" | awk -F '.' '{print $2}')
            export RELEASE_VERSION_PATCH=$(echo "$GRAVITEEIO_VERSION" | awk -F '.' '{print $3}')
            if [ "${DRY_RUN}" == "false" ]; then
              # --->>> NO IT IS NOT A DRY RUN
              echo "# --->>> NO IT IS NOT A DRY RUN : GO DOCKER PUSH"
              if [ "${TAG_LATEST}" == "true" ]; then
                # --->>> NO IT IS NOT A DRY RUN
                echo "# --->>> NO IT IS NOT A DRY RUN : THIS IS A LATEST RELEASE"
                docker push "graviteeio/am-management-api:${RELEASE_VERSION_MAJOR}-ee"
                docker push "graviteeio/am-management-api:${RELEASE_VERSION_MAJOR}.${RELEASE_VERSION_MINOR}-ee"
                docker push "graviteeio/am-management-api:${RELEASE_VERSION}-ee"
              else
                echo "# --->>> THIS IS A DRY RUN : THIS IS NOT A LATEST RELEASE, SO WILL DOCKER PUSH ONLY [${RELEASE_VERSION}]=[${RELEASE_VERSION_MAJOR}.${RELEASE_VERSION_MINOR}.${RELEASE_VERSION_PATCH}]"
                docker push "graviteeio/am-management-api:${RELEASE_VERSION}-ee"
                if [ "$TAG_LATEST_SUPPORT" == "true" ]; then
                    echo "Gravitee Containers :  Docker tags, Releasing Docker images as latest support"
                    docker push "graviteeio/am-management-api:${RELEASE_VERSION_MAJOR}.${RELEASE_VERSION_MINOR}-ee"
                else
                    echo "Gravitee Containers :  Docker tags, Releasing Docker images as NON-latest"
                fi
              fi;
            else
              echo "# --->>> THIS IS A DRY RUN : SKIPPING DOCKER PUSH"
            fi;


  build_n_push_am_ee_v3_ui_job:
    machine:
      image: 'ubuntu-1604:201903-01'
      resource_class: large
      docker_layer_caching: true    # default - false # requires a Circle CI plan that includes [Docker layer caching feature]
    environment:
      DRY_RUN: << pipeline.parameters.dry_run >>
      TAG_LATEST: << pipeline.parameters.tag_latest >>
      TAG_LATEST_SUPPORT: << pipeline.parameters.tag_latest_support >>
      PRUNE_IT_ALL: << pipeline.parameters.prune >>
      GRAVITEEIO_VERSION: << pipeline.parameters.graviteeio_version >>
      SECRETHUB_ORG: << pipeline.parameters.secrethub_org >>
      SECRETHUB_REPO: << pipeline.parameters.secrethub_repo >>
    steps:
      - checkout
      - secrethub/install
      - gravitee/git_config:
          secrethub_org: << pipeline.parameters.secrethub_org >>
          secrethub_repo: << pipeline.parameters.secrethub_repo >>
      - run:
          name: "Gravitee AM EE v3 Management UI: Check Environment"
          command: |
            pwd
            ls -allh
            export OPS_HOME=$(pwd)
            export RELEASE_VERSION=$GRAVITEEIO_VERSION
            export RELEASE_VERSION_MAJOR=$(echo "$GRAVITEEIO_VERSION" | awk -F '.' '{print $1}')
            export RELEASE_VERSION_MINOR=$(echo "$GRAVITEEIO_VERSION" | awk -F '.' '{print $2}')
            export RELEASE_VERSION_PATCH=$(echo "$GRAVITEEIO_VERSION" | awk -F '.' '{print $3}')
            echo " "
            echo " [--------------------------------------------------------------------------------] "
            echo " [--------------------------------------------------------------------------------] "
            echo " [--------------------------------------------------------------------------------] "
            echo " [--------------------------------------------------------------------------------] "
            echo "                            FOR THE DOCKER RELEASE : "
            echo "                                "
            echo " [--------------------------------------------------------------------------------] "
            echo "      RELEASE_VERSION=[${RELEASE_VERSION}]"
            echo "      RELEASE_VERSION_MAJOR=[${RELEASE_VERSION_MAJOR}]"
            echo "      RELEASE_VERSION_MINOR=[${RELEASE_VERSION_MINOR}]"
            echo "      RELEASE_VERSION_PATCH=[${RELEASE_VERSION_PATCH}]"
            echo " [--------------------------------------------------------------------------------] "
            echo " [--------------------------------------------------------------------------------] "
            echo " [--------------------------------------------------------------------------------] "
            if ! [ "${RELEASE_VERSION_MAJOR}" == "3" ]; then
              echo "The [${RELEASE_VERSION}] version is not a Gravitee V3 Generation version"
              exit 3
            fi;
      - run:
          name: "Prune"
          command: |
            if [ "$PRUNE_IT_ALL" == "true" ]; then
              echo "Pruning all Docker images"
              docker system prune -f --all
            else
              echo "Skipped Pruning all Docker images "
            fi;
      - run:
          name: "If Dry run, build Community Edition Container Images"
          command: |
            echo " [--------------------------------------------------------------------------------] "
            echo "    Gravitee AM Entreprise Edition UI Image is built FROM Community Edition Image"
            echo "    If this job is run with DRY RUN mode on, Community Edition Image is not"
            echo "     pushed to Dockerhub, so will be missing for "
            echo "     Gravitee AM Entreprise Edition UI Image Container build"
            echo " [--------------------------------------------------------------------------------] "

            if [ "${DRY_RUN}" == "true" ]; then
              echo "# --->>> THIS IS A DRY RUN : BUILDING COMMUNITY EDITION CONTAINER IMAGE"
              # Testing if the git config properly configured SSH Agent
              echo "# ==> Testing if the git config properly configured SSH Agent"
              ssh -T git@github.com || true

              pwd
              ls -allh
              export OPS_HOME=$(pwd)
              export RELEASE_VERSION=$GRAVITEEIO_VERSION
              export RELEASE_VERSION_MAJOR=$(echo "$GRAVITEEIO_VERSION" | awk -F '.' '{print $1}')
              export RELEASE_VERSION_MINOR=$(echo "$GRAVITEEIO_VERSION" | awk -F '.' '{print $2}')
              export RELEASE_VERSION_PATCH=$(echo "$GRAVITEEIO_VERSION" | awk -F '.' '{print $3}')
              #
              # Secure docker images tagging
              if ! [ "${RELEASE_VERSION}" == "${RELEASE_VERSION_MAJOR}.${RELEASE_VERSION_MINOR}.${RELEASE_VERSION_PATCH}" ]; then
                echo "[${RELEASE_VERSION}] and [${RELEASE_VERSION_MAJOR}.${RELEASE_VERSION_MINOR}.${RELEASE_VERSION_PATCH}] should be equal, and are not, stopping pipeline, debug and check pipeline."
                exit 3
              fi;
              echo " Docker build: Gravitee Access Management version [${GRAVITEEIO_VERSION}]"
              export DOCKER_WORKSHOP=$(mktemp -d -t "access_management-XXXXXXXXXX")
              export GIT_SSH_URI=git@github.com:gravitee-io/graviteeio-access-management.git
              cd ${OPS_HOME}
              git clone ${GIT_SSH_URI} ${DOCKER_WORKSHOP}
              cd ${DOCKER_WORKSHOP}
              git checkout "${GRAVITEEIO_VERSION}"
              cd ${OPS_HOME}
              echo " [++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++] "
              echo " [--------------------------------------------------------------------------------] "
              echo "                            DOCKER BUILD GRAVITEE AM MANAGEMENT UI : "
              echo " [--------------------------------------------------------------------------------] "
              docker build -f ${DOCKER_WORKSHOP}/docker/management-ui/Dockerfile --build-arg GRAVITEEAM_VERSION=${RELEASE_VERSION} -t graviteeio/am-management-ui:${RELEASE_VERSION} ${DOCKER_WORKSHOP}/docker/management-ui/
              docker images
            else
              echo "# --->>> THIS IS NOT A DRY RUN : SKIP BUILDING COMMUNITY EDITION CONTAINER IMAGE"
            fi;

      - run:
          name: "Gravitee AM EE v3 Management UI: Build Container Image"
          command: |
            export RELEASE_VERSION=$GRAVITEEIO_VERSION
            export RELEASE_VERSION_MAJOR=$(echo "$GRAVITEEIO_VERSION" | awk -F '.' '{print $1}')
            export RELEASE_VERSION_MINOR=$(echo "$GRAVITEEIO_VERSION" | awk -F '.' '{print $2}')
            export RELEASE_VERSION_PATCH=$(echo "$GRAVITEEIO_VERSION" | awk -F '.' '{print $3}')
            echo ""
            echo " [--------------------------------------------------------------------------------] "
            echo "                            DOCKER BUILD GRAVITEE AM MANAGEMENT UI : "
            echo " [--------------------------------------------------------------------------------] "
            docker build -f ./enterprise/am/3.x/management-ui/Dockerfile --build-arg GRAVITEEIO_AM_VERSION=${RELEASE_VERSION} -t "graviteeio/am-management-ui:${RELEASE_VERSION}-ee" ./enterprise/am/3.x/management-ui/
            docker tag "graviteeio/am-management-ui:${RELEASE_VERSION}-ee" "graviteeio/am-management-ui:${RELEASE_VERSION_MAJOR}-ee"
            docker tag "graviteeio/am-management-ui:${RELEASE_VERSION}-ee" "graviteeio/am-management-ui:${RELEASE_VERSION_MAJOR}.${RELEASE_VERSION_MINOR}-ee"
            docker images
      - gravitee/docker_login:
          secrethub_org: << pipeline.parameters.secrethub_org >>
          secrethub_repo: << pipeline.parameters.secrethub_repo >>

      - run:
          name: "Gravitee AM EE v3 Management UI: Docker Push Container Image"
          command: |
            export RELEASE_VERSION=$GRAVITEEIO_VERSION
            export RELEASE_VERSION_MAJOR=$(echo "$GRAVITEEIO_VERSION" | awk -F '.' '{print $1}')
            export RELEASE_VERSION_MINOR=$(echo "$GRAVITEEIO_VERSION" | awk -F '.' '{print $2}')
            export RELEASE_VERSION_PATCH=$(echo "$GRAVITEEIO_VERSION" | awk -F '.' '{print $3}')
            if [ "${DRY_RUN}" == "false" ]; then
              # --->>> NO IT IS NOT A DRY RUN
              echo "# --->>> NO IT IS NOT A DRY RUN : GO DOCKER PUSH"
              if [ "${TAG_LATEST}" == "true" ]; then
                # --->>> NO IT IS NOT A DRY RUN
                echo "# --->>> NO IT IS NOT A DRY RUN : THIS IS A LATEST RELEASE"
                docker push "graviteeio/am-management-ui:${RELEASE_VERSION_MAJOR}-ee"
                docker push "graviteeio/am-management-ui:${RELEASE_VERSION_MAJOR}.${RELEASE_VERSION_MINOR}-ee"
                docker push "graviteeio/am-management-ui:${RELEASE_VERSION}-ee"
              else
                echo "# --->>> THIS IS A DRY RUN : THIS IS NOT A LATEST RELEASE, SO WILL DOCKER PUSH ONLY [${RELEASE_VERSION}]=[${RELEASE_VERSION_MAJOR}.${RELEASE_VERSION_MINOR}.${RELEASE_VERSION_PATCH}]"
                docker push "graviteeio/am-management-ui:${RELEASE_VERSION}-ee"
                if [ "$TAG_LATEST_SUPPORT" == "true" ]; then
                    echo "Gravitee Containers :  Docker tags, Releasing Docker images as latest support"
                    docker push "graviteeio/am-management-ui:${RELEASE_VERSION_MAJOR}.${RELEASE_VERSION_MINOR}-ee"
                else
                    echo "Gravitee Containers :  Docker tags, Releasing Docker images as NON-latest"
                fi
              fi;
            else
              echo "# --->>> THIS IS A DRY RUN : SKIPPING DOCKER PUSH"
            fi;
  # ---
  # Builds all the container images : Gravitee AM EE v2
  build_n_push_am_ee_v2_gateway_job:
    machine:
      image: 'ubuntu-1604:201903-01'
      resource_class: large
      docker_layer_caching: true    # default - false # requires a Circle CI plan that includes [Docker layer caching feature]
    environment:
      DRY_RUN: << pipeline.parameters.dry_run >>
      TAG_LATEST: << pipeline.parameters.tag_latest >>
      TAG_LATEST_SUPPORT: << pipeline.parameters.tag_latest_support >>
      PRUNE_IT_ALL: << pipeline.parameters.prune >>
      GRAVITEEIO_VERSION: << pipeline.parameters.graviteeio_version >>
      SECRETHUB_ORG: << pipeline.parameters.secrethub_org >>
      SECRETHUB_REPO: << pipeline.parameters.secrethub_repo >>
    steps:
      - checkout
      - secrethub/install
      - gravitee/git_config:
          secrethub_org: << pipeline.parameters.secrethub_org >>
          secrethub_repo: << pipeline.parameters.secrethub_repo >>
      - run:
          name: "Gravitee AM EE v2 Gateway: Check Environment"
          command: |
            pwd
            ls -allh
            export OPS_HOME=$(pwd)
            export RELEASE_VERSION=$GRAVITEEIO_VERSION
            export RELEASE_VERSION_MAJOR=$(echo "$GRAVITEEIO_VERSION" | awk -F '.' '{print $1}')
            export RELEASE_VERSION_MINOR=$(echo "$GRAVITEEIO_VERSION" | awk -F '.' '{print $2}')
            export RELEASE_VERSION_PATCH=$(echo "$GRAVITEEIO_VERSION" | awk -F '.' '{print $3}')
            echo " "
            echo " [--------------------------------------------------------------------------------] "
            echo " [--------------------------------------------------------------------------------] "
            echo " [--------------------------------------------------------------------------------] "
            echo " [--------------------------------------------------------------------------------] "
            echo "                            FOR THE DOCKER RELEASE : "
            echo "                                "
            echo " [--------------------------------------------------------------------------------] "
            echo "      RELEASE_VERSION=[${RELEASE_VERSION}]"
            echo "      RELEASE_VERSION_MAJOR=[${RELEASE_VERSION_MAJOR}]"
            echo "      RELEASE_VERSION_MINOR=[${RELEASE_VERSION_MINOR}]"
            echo "      RELEASE_VERSION_PATCH=[${RELEASE_VERSION_PATCH}]"
            echo " [--------------------------------------------------------------------------------] "
            echo " [--------------------------------------------------------------------------------] "
            echo " [--------------------------------------------------------------------------------] "
            if ! [ "${RELEASE_VERSION_MAJOR}" == "2" ]; then
              echo "The [${RELEASE_VERSION}] version is not a Gravitee V2 Generation version"
              exit 3
            fi;
      - run:
          name: "If Dry run, build Community Edition Container Images"
          command: |
            echo " [--------------------------------------------------------------------------------] "
            echo "    Gravitee AM Entreprise Edition UI Image is built FROM Community Edition Image"
            echo "    If this job is run with DRY RUN mode on, Community Edition Image is not"
            echo "     pushed to Dockerhub, so will be missing for "
            echo "     Gravitee AM Entreprise Edition UI Image Container build"
            echo " [--------------------------------------------------------------------------------] "

            if [ "${DRY_RUN}" == "true" ]; then
              echo "# --->>> THIS IS A DRY RUN : BUILDING COMMUNITY EDITION CONTAINER IMAGE"
              # Testing if the git config properly configured SSH Agent
              echo "# ==> Testing if the git config properly configured SSH Agent"
              ssh -T git@github.com || true

              pwd
              ls -allh
              export OPS_HOME=$(pwd)
              export RELEASE_VERSION=$GRAVITEEIO_VERSION
              export RELEASE_VERSION_MAJOR=$(echo "$GRAVITEEIO_VERSION" | awk -F '.' '{print $1}')
              export RELEASE_VERSION_MINOR=$(echo "$GRAVITEEIO_VERSION" | awk -F '.' '{print $2}')
              export RELEASE_VERSION_PATCH=$(echo "$GRAVITEEIO_VERSION" | awk -F '.' '{print $3}')
              #
              # Secure docker images tagging
              if ! [ "${RELEASE_VERSION}" == "${RELEASE_VERSION_MAJOR}.${RELEASE_VERSION_MINOR}.${RELEASE_VERSION_PATCH}" ]; then
                echo "[${RELEASE_VERSION}] and [${RELEASE_VERSION_MAJOR}.${RELEASE_VERSION_MINOR}.${RELEASE_VERSION_PATCH}] should be equal, and are not, stopping pipeline, debug and check pipeline."
                exit 3
              fi;
              echo " Docker build: Gravitee Access Management version [${GRAVITEEIO_VERSION}]"
              export DOCKER_WORKSHOP=$(mktemp -d -t "access_management-XXXXXXXXXX")
              export GIT_SSH_URI=git@github.com:gravitee-io/graviteeio-access-management.git
              cd ${OPS_HOME}
              git clone ${GIT_SSH_URI} ${DOCKER_WORKSHOP}
              cd ${DOCKER_WORKSHOP}
              git checkout "${GRAVITEEIO_VERSION}"
              cd ${OPS_HOME}
              echo " [++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++] "
              echo " [--------------------------------------------------------------------------------] "
              echo "                            DOCKER BUILD GRAVITEE AM GATEWAY : "
              echo " [--------------------------------------------------------------------------------] "
              docker build -f ${DOCKER_WORKSHOP}/docker/gateway/Dockerfile --build-arg GRAVITEEAM_VERSION=${RELEASE_VERSION} -t graviteeio/am-gateway:${RELEASE_VERSION} ${DOCKER_WORKSHOP}/docker/gateway/
              docker images
            else
              echo "# --->>> THIS IS NOT A DRY RUN : SKIP BUILDING COMMUNITY EDITION CONTAINER IMAGE"
            fi;
      - run:
          name: "Gravitee AM EE v2 Gateway: Build Container Image"
          command: |
            export RELEASE_VERSION=$GRAVITEEIO_VERSION
            export RELEASE_VERSION_MAJOR=$(echo "$GRAVITEEIO_VERSION" | awk -F '.' '{print $1}')
            export RELEASE_VERSION_MINOR=$(echo "$GRAVITEEIO_VERSION" | awk -F '.' '{print $2}')
            export RELEASE_VERSION_PATCH=$(echo "$GRAVITEEIO_VERSION" | awk -F '.' '{print $3}')
            echo ""
            echo " [--------------------------------------------------------------------------------] "
            echo "                            DOCKER BUILD GRAVITEE AM GATEWAY : "
            echo " [--------------------------------------------------------------------------------] "
            docker build -f ./enterprise/am/2.x/gateway/Dockerfile --build-arg GRAVITEEIO_AM_VERSION=${RELEASE_VERSION} -t "graviteeio/am-gateway:${RELEASE_VERSION}-ee" ./enterprise/am/2.x/gateway/
            docker tag "graviteeio/am-gateway:${RELEASE_VERSION}-ee" "graviteeio/am-gateway:${RELEASE_VERSION_MAJOR}-ee"
            docker tag "graviteeio/am-gateway:${RELEASE_VERSION}-ee" "graviteeio/am-gateway:${RELEASE_VERSION_MAJOR}.${RELEASE_VERSION_MINOR}-ee"
            docker images

      - gravitee/docker_login:
          secrethub_org: << pipeline.parameters.secrethub_org >>
          secrethub_repo: << pipeline.parameters.secrethub_repo >>

      - run:
          name: "Gravitee AM EE v2 Gateway: Docker Push Container Image"
          command: |
            export RELEASE_VERSION=$GRAVITEEIO_VERSION
            export RELEASE_VERSION_MAJOR=$(echo "$GRAVITEEIO_VERSION" | awk -F '.' '{print $1}')
            export RELEASE_VERSION_MINOR=$(echo "$GRAVITEEIO_VERSION" | awk -F '.' '{print $2}')
            export RELEASE_VERSION_PATCH=$(echo "$GRAVITEEIO_VERSION" | awk -F '.' '{print $3}')
            if [ "${DRY_RUN}" == "false" ]; then
              # --->>> NO IT IS NOT A DRY RUN
              echo "# --->>> NO IT IS NOT A DRY RUN : GO DOCKER PUSH"
              if [ "${TAG_LATEST}" == "true" ]; then
                # --->>> NO IT IS NOT A DRY RUN
                echo "# --->>> NO IT IS NOT A DRY RUN : THIS IS A LATEST RELEASE"
                docker push "graviteeio/am-gateway:${RELEASE_VERSION_MAJOR}-ee"
                docker push "graviteeio/am-gateway:${RELEASE_VERSION_MAJOR}.${RELEASE_VERSION_MINOR}-ee"
                docker push "graviteeio/am-gateway:${RELEASE_VERSION}-ee"
              else
                echo "# --->>> THIS IS A DRY RUN : THIS IS NOT A LATEST RELEASE, SO WILL DOCKER PUSH ONLY [${RELEASE_VERSION}]=[${RELEASE_VERSION_MAJOR}.${RELEASE_VERSION_MINOR}.${RELEASE_VERSION_PATCH}]"
                docker push "graviteeio/am-gateway:${RELEASE_VERSION}-ee"
                if [ "$TAG_LATEST_SUPPORT" == "true" ]; then
                    echo "Gravitee Containers :  Docker tags, Releasing Docker images as latest support"
                    docker push "graviteeio/am-gateway:${RELEASE_VERSION_MAJOR}.${RELEASE_VERSION_MINOR}-ee"
                else
                    echo "Gravitee Containers :  Docker tags, Releasing Docker images as NON-latest"
                fi
              fi;
            else
              echo "# --->>> THIS IS A DRY RUN : SKIPPING DOCKER PUSH"
            fi;


  build_n_push_am_ee_v2_api_job:
    machine:
      image: 'ubuntu-1604:201903-01'
      resource_class: large
      docker_layer_caching: true    # default - false # requires a Circle CI plan that includes [Docker layer caching feature]
    environment:
      DRY_RUN: << pipeline.parameters.dry_run >>
      TAG_LATEST: << pipeline.parameters.tag_latest >>
      TAG_LATEST_SUPPORT: << pipeline.parameters.tag_latest_support >>
      PRUNE_IT_ALL: << pipeline.parameters.prune >>
      GRAVITEEIO_VERSION: << pipeline.parameters.graviteeio_version >>
      SECRETHUB_ORG: << pipeline.parameters.secrethub_org >>
      SECRETHUB_REPO: << pipeline.parameters.secrethub_repo >>
    steps:
      - checkout
      - secrethub/install
      - gravitee/git_config:
          secrethub_org: << pipeline.parameters.secrethub_org >>
          secrethub_repo: << pipeline.parameters.secrethub_repo >>
      - run:
          name: "Gravitee AM EE v2 Management API: Check Environment"
          command: |
            pwd
            ls -allh
            export OPS_HOME=$(pwd)
            export RELEASE_VERSION=$GRAVITEEIO_VERSION
            export RELEASE_VERSION_MAJOR=$(echo "$GRAVITEEIO_VERSION" | awk -F '.' '{print $1}')
            export RELEASE_VERSION_MINOR=$(echo "$GRAVITEEIO_VERSION" | awk -F '.' '{print $2}')
            export RELEASE_VERSION_PATCH=$(echo "$GRAVITEEIO_VERSION" | awk -F '.' '{print $3}')
            echo " "
            echo " [--------------------------------------------------------------------------------] "
            echo " [--------------------------------------------------------------------------------] "
            echo " [--------------------------------------------------------------------------------] "
            echo " [--------------------------------------------------------------------------------] "
            echo "                            FOR THE DOCKER RELEASE : "
            echo "                                "
            echo " [--------------------------------------------------------------------------------] "
            echo "      RELEASE_VERSION=[${RELEASE_VERSION}]"
            echo "      RELEASE_VERSION_MAJOR=[${RELEASE_VERSION_MAJOR}]"
            echo "      RELEASE_VERSION_MINOR=[${RELEASE_VERSION_MINOR}]"
            echo "      RELEASE_VERSION_PATCH=[${RELEASE_VERSION_PATCH}]"
            echo " [--------------------------------------------------------------------------------] "
            echo " [--------------------------------------------------------------------------------] "
            echo " [--------------------------------------------------------------------------------] "
            if ! [ "${RELEASE_VERSION_MAJOR}" == "2" ]; then
              echo "The [${RELEASE_VERSION}] version is not a Gravitee V2 Generation version"
              exit 3
            fi;
      - run:
          name: "If Dry run, build Community Edition Container Images"
          command: |
            echo " [--------------------------------------------------------------------------------] "
            echo "    Gravitee AM Entreprise Edition UI Image is built FROM Community Edition Image"
            echo "    If this job is run with DRY RUN mode on, Community Edition Image is not"
            echo "     pushed to Dockerhub, so will be missing for "
            echo "     Gravitee AM Entreprise Edition UI Image Container build"
            echo " [--------------------------------------------------------------------------------] "

            if [ "${DRY_RUN}" == "true" ]; then
              echo "# --->>> THIS IS A DRY RUN : BUILDING COMMUNITY EDITION CONTAINER IMAGE"
              # Testing if the git config properly configured SSH Agent
              echo "# ==> Testing if the git config properly configured SSH Agent"
              ssh -T git@github.com || true

              pwd
              ls -allh
              export OPS_HOME=$(pwd)
              export RELEASE_VERSION=$GRAVITEEIO_VERSION
              export RELEASE_VERSION_MAJOR=$(echo "$GRAVITEEIO_VERSION" | awk -F '.' '{print $1}')
              export RELEASE_VERSION_MINOR=$(echo "$GRAVITEEIO_VERSION" | awk -F '.' '{print $2}')
              export RELEASE_VERSION_PATCH=$(echo "$GRAVITEEIO_VERSION" | awk -F '.' '{print $3}')
              #
              # Secure docker images tagging
              if ! [ "${RELEASE_VERSION}" == "${RELEASE_VERSION_MAJOR}.${RELEASE_VERSION_MINOR}.${RELEASE_VERSION_PATCH}" ]; then
                echo "[${RELEASE_VERSION}] and [${RELEASE_VERSION_MAJOR}.${RELEASE_VERSION_MINOR}.${RELEASE_VERSION_PATCH}] should be equal, and are not, stopping pipeline, debug and check pipeline."
                exit 3
              fi;
              echo " Docker build: Gravitee Access Management version [${GRAVITEEIO_VERSION}]"
              export DOCKER_WORKSHOP=$(mktemp -d -t "access_management-XXXXXXXXXX")
              export GIT_SSH_URI=git@github.com:gravitee-io/graviteeio-access-management.git
              cd ${OPS_HOME}
              git clone ${GIT_SSH_URI} ${DOCKER_WORKSHOP}
              cd ${DOCKER_WORKSHOP}
              git checkout "${GRAVITEEIO_VERSION}"
              cd ${OPS_HOME}
              echo " [++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++] "
              echo " [--------------------------------------------------------------------------------] "
              echo "                            DOCKER BUILD GRAVITEE AM MANAGEMENT API : "
              echo " [--------------------------------------------------------------------------------] "
              docker build -f ${DOCKER_WORKSHOP}/docker/management-api/Dockerfile --build-arg GRAVITEEAM_VERSION=${RELEASE_VERSION} -t graviteeio/am-management-api:${RELEASE_VERSION} ${DOCKER_WORKSHOP}/docker/management-api/
              docker images
            else
              echo "# --->>> THIS IS NOT A DRY RUN : SKIP BUILDING COMMUNITY EDITION CONTAINER IMAGE"
            fi;
      - run:
          name: "Gravitee AM EE v2 Management API: Build Container Image"
          command: |
            export RELEASE_VERSION=$GRAVITEEIO_VERSION
            export RELEASE_VERSION_MAJOR=$(echo "$GRAVITEEIO_VERSION" | awk -F '.' '{print $1}')
            export RELEASE_VERSION_MINOR=$(echo "$GRAVITEEIO_VERSION" | awk -F '.' '{print $2}')
            export RELEASE_VERSION_PATCH=$(echo "$GRAVITEEIO_VERSION" | awk -F '.' '{print $3}')
            echo ""
            echo " [--------------------------------------------------------------------------------] "
            echo "                            DOCKER BUILD GRAVITEE AM MANAGEMENT API : "
            echo " [--------------------------------------------------------------------------------] "
            docker build -f ./enterprise/am/2.x/management-api/Dockerfile --build-arg GRAVITEEIO_AM_VERSION=${RELEASE_VERSION} -t "graviteeio/am-management-api:${RELEASE_VERSION}-ee" ./enterprise/am/2.x/management-api/
            docker tag "graviteeio/am-management-api:${RELEASE_VERSION}-ee" "graviteeio/am-management-api:${RELEASE_VERSION_MAJOR}-ee"
            docker tag "graviteeio/am-management-api:${RELEASE_VERSION}-ee" "graviteeio/am-management-api:${RELEASE_VERSION_MAJOR}.${RELEASE_VERSION_MINOR}-ee"
            docker images
      - gravitee/docker_login:
          secrethub_org: << pipeline.parameters.secrethub_org >>
          secrethub_repo: << pipeline.parameters.secrethub_repo >>

      - run:
          name: "Gravitee AM EE v2 Management API: Docker Push Container Image"
          command: |
            export RELEASE_VERSION=$GRAVITEEIO_VERSION
            export RELEASE_VERSION_MAJOR=$(echo "$GRAVITEEIO_VERSION" | awk -F '.' '{print $1}')
            export RELEASE_VERSION_MINOR=$(echo "$GRAVITEEIO_VERSION" | awk -F '.' '{print $2}')
            export RELEASE_VERSION_PATCH=$(echo "$GRAVITEEIO_VERSION" | awk -F '.' '{print $3}')
            if [ "${DRY_RUN}" == "false" ]; then
              # --->>> NO IT IS NOT A DRY RUN
              echo "# --->>> NO IT IS NOT A DRY RUN : GO DOCKER PUSH"
              if [ "${TAG_LATEST}" == "true" ]; then
                # --->>> NO IT IS NOT A DRY RUN
                echo "# --->>> THIS IS A LATEST RELEASE"
                docker push "graviteeio/am-management-api:${RELEASE_VERSION_MAJOR}-ee"
                docker push "graviteeio/am-management-api:${RELEASE_VERSION_MAJOR}.${RELEASE_VERSION_MINOR}-ee"
                docker push "graviteeio/am-management-api:${RELEASE_VERSION}-ee"
              else
                echo "# --->>> THIS IS NOT A LATEST RELEASE, SO WILL DOCKER PUSH ONLY [${RELEASE_VERSION}]=[${RELEASE_VERSION_MAJOR}.${RELEASE_VERSION_MINOR}.${RELEASE_VERSION_PATCH}]"
                docker push "graviteeio/am-management-api:${RELEASE_VERSION}-ee"
                if [ "$TAG_LATEST_SUPPORT" == "true" ]; then
                    echo "Gravitee Containers :  Docker tags, Releasing Docker images as latest support"
                    docker push "graviteeio/am-gateway:${RELEASE_VERSION_MAJOR}.${RELEASE_VERSION_MINOR}-ee"
                else
                    echo "Gravitee Containers :  Docker tags, Releasing Docker images as NON-latest"
                fi
              fi;
            else
              echo "# --->>> THIS IS A DRY RUN : SKIPPING DOCKER PUSH"
            fi;

  build_n_push_am_ee_v2_ui_job:
    machine:
      image: 'ubuntu-1604:201903-01'
      resource_class: large
      docker_layer_caching: true    # default - false # requires a Circle CI plan that includes [Docker layer caching feature]
    environment:
      DRY_RUN: << pipeline.parameters.dry_run >>
      TAG_LATEST: << pipeline.parameters.tag_latest >>
      TAG_LATEST_SUPPORT: << pipeline.parameters.tag_latest_support >>
      PRUNE_IT_ALL: << pipeline.parameters.prune >>
      GRAVITEEIO_VERSION: << pipeline.parameters.graviteeio_version >>
      SECRETHUB_ORG: << pipeline.parameters.secrethub_org >>
      SECRETHUB_REPO: << pipeline.parameters.secrethub_repo >>
    steps:
      - checkout
      - secrethub/install
      - gravitee/git_config:
          secrethub_org: << pipeline.parameters.secrethub_org >>
          secrethub_repo: << pipeline.parameters.secrethub_repo >>
      - run:
          name: "Gravitee AM EE v2 Management UI: Check Environment"
          command: |
            pwd
            ls -allh
            export OPS_HOME=$(pwd)
            export RELEASE_VERSION=$GRAVITEEIO_VERSION
            export RELEASE_VERSION_MAJOR=$(echo "$GRAVITEEIO_VERSION" | awk -F '.' '{print $1}')
            export RELEASE_VERSION_MINOR=$(echo "$GRAVITEEIO_VERSION" | awk -F '.' '{print $2}')
            export RELEASE_VERSION_PATCH=$(echo "$GRAVITEEIO_VERSION" | awk -F '.' '{print $3}')
            echo " "
            echo " [--------------------------------------------------------------------------------] "
            echo " [--------------------------------------------------------------------------------] "
            echo " [--------------------------------------------------------------------------------] "
            echo " [--------------------------------------------------------------------------------] "
            echo "                            FOR THE DOCKER RELEASE : "
            echo "                                "
            echo " [--------------------------------------------------------------------------------] "
            echo "      RELEASE_VERSION=[${RELEASE_VERSION}]"
            echo "      RELEASE_VERSION_MAJOR=[${RELEASE_VERSION_MAJOR}]"
            echo "      RELEASE_VERSION_MINOR=[${RELEASE_VERSION_MINOR}]"
            echo "      RELEASE_VERSION_PATCH=[${RELEASE_VERSION_PATCH}]"
            echo " [--------------------------------------------------------------------------------] "
            echo " [--------------------------------------------------------------------------------] "
            echo " [--------------------------------------------------------------------------------] "
            if ! [ "${RELEASE_VERSION_MAJOR}" == "2" ]; then
              echo "The [${RELEASE_VERSION}] version is not a Gravitee V2 Generation version"
              exit 3
            fi;
      - run:
          name: "If Dry run, build Community Edition Container Images"
          command: |
            echo " [--------------------------------------------------------------------------------] "
            echo "    Gravitee AM Entreprise Edition UI Image is built FROM Community Edition Image"
            echo "    If this job is run with DRY RUN mode on, Community Edition Image is not"
            echo "     pushed to Dockerhub, so will be missing for "
            echo "     Gravitee AM Entreprise Edition UI Image Container build"
            echo " [--------------------------------------------------------------------------------] "

            if [ "${DRY_RUN}" == "true" ]; then
              echo "# --->>> THIS IS A DRY RUN : BUILDING COMMUNITY EDITION CONTAINER IMAGE"
              # Testing if the git config properly configured SSH Agent
              echo "# ==> Testing if the git config properly configured SSH Agent"
              ssh -T git@github.com || true

              pwd
              ls -allh
              export OPS_HOME=$(pwd)
              export RELEASE_VERSION=$GRAVITEEIO_VERSION
              export RELEASE_VERSION_MAJOR=$(echo "$GRAVITEEIO_VERSION" | awk -F '.' '{print $1}')
              export RELEASE_VERSION_MINOR=$(echo "$GRAVITEEIO_VERSION" | awk -F '.' '{print $2}')
              export RELEASE_VERSION_PATCH=$(echo "$GRAVITEEIO_VERSION" | awk -F '.' '{print $3}')
              #
              # Secure docker images tagging
              if ! [ "${RELEASE_VERSION}" == "${RELEASE_VERSION_MAJOR}.${RELEASE_VERSION_MINOR}.${RELEASE_VERSION_PATCH}" ]; then
                echo "[${RELEASE_VERSION}] and [${RELEASE_VERSION_MAJOR}.${RELEASE_VERSION_MINOR}.${RELEASE_VERSION_PATCH}] should be equal, and are not, stopping pipeline, debug and check pipeline."
                exit 3
              fi;
              echo " Docker build: Gravitee Access Management version [${GRAVITEEIO_VERSION}]"
              export DOCKER_WORKSHOP=$(mktemp -d -t "access_management-XXXXXXXXXX")
              export GIT_SSH_URI=git@github.com:gravitee-io/graviteeio-access-management.git
              cd ${OPS_HOME}
              git clone ${GIT_SSH_URI} ${DOCKER_WORKSHOP}
              cd ${DOCKER_WORKSHOP}
              git checkout "${GRAVITEEIO_VERSION}"
              cd ${OPS_HOME}
              echo " [++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++] "
              echo " [--------------------------------------------------------------------------------] "
              echo "                            DOCKER BUILD GRAVITEE AM MANAGEMENT UI : "
              echo " [--------------------------------------------------------------------------------] "
              docker build -f ${DOCKER_WORKSHOP}/docker/management-ui/Dockerfile --build-arg GRAVITEEAM_VERSION=${RELEASE_VERSION} -t graviteeio/am-management-ui:${RELEASE_VERSION} ${DOCKER_WORKSHOP}/docker/management-ui/
              docker images
            else
              echo "# --->>> THIS IS NOT A DRY RUN : SKIP BUILDING COMMUNITY EDITION CONTAINER IMAGE"
            fi;

  # ---
  # Builds all the container images defined in [images/] folder, which are
  # not proper Gravitee Products (Container Library Images)
  gravitee_oci_lib_job:
    machine:
      image: 'ubuntu-1604:201903-01'
      resource_class: large
      docker_layer_caching: true    # default - false # requires a Circle CI plan that includes [Docker layer caching feature]
    environment:
      DRY_RUN: << pipeline.parameters.dry_run >>
      TAG_LATEST: << pipeline.parameters.tag_latest >>
      PRUNE_IT_ALL: << pipeline.parameters.prune >>
      GRAVITEEIO_JAVA_VERSION: << pipeline.parameters.graviteeio_java_version >>
      GRAVITEEIO_PYTHON_VERSION: << pipeline.parameters.graviteeio_python_version >>
      SECRETHUB_ORG: << pipeline.parameters.secrethub_org >>
      SECRETHUB_REPO: << pipeline.parameters.secrethub_repo >>
    steps:
      - checkout
      - secrethub/install
      - gravitee/git_config:
          secrethub_org: << pipeline.parameters.secrethub_org >>
          secrethub_repo: << pipeline.parameters.secrethub_repo >>
      - run:
          name: "Prune"
          command: |
                    if [ "$PRUNE_IT_ALL" == "true" ]; then
                      echo "Pruning all Docker images "
                      docker system prune -f --all
                    else
                      echo "Skipped Pruning all Docker images "
                    fi;
      - run:
          name: "Docker Images - Checking environment : Gravitee Container Library"
          command: |
                    echo "Docker version is : "
                    docker version
                    echo "TAG_LATEST=[${TAG_LATEST}]"
                    echo "SECRETHUB_ORG=[${SECRETHUB_ORG}]"
                    echo "SECRETHUB_REPO=[${SECRETHUB_REPO}]"
                    echo "GRAVITEEIO_JAVA_VERSION=[${GRAVITEEIO_JAVA_VERSION}]"
                    # ---
                    # Testing if the git config properly configured SSH Agent
                    echo "# ==> Testing if the git config properly configured SSH Agent"
                    ssh -T git@github.com || true
      - run:
          name: "Build Docker Images: Gravitee Container Library"
          command: |
            pwd
            ls -allh
            export OPS_HOME=$(pwd)
            echo " Docker build: Gravitee Container library]"
            echo " [++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++] "
            echo " [--------------------------------------------------------------------------------] "
            echo "                            DOCKER BUILD GRAVITEE CONTAINERS LIB IMAGES : "
            echo " [--------------------------------------------------------------------------------] "
            echo " [++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++] "
            echo " [--------------------------------------------------------------------------------] "
            echo "                         DOCKER BUILD [graviteeio/java:${GRAVITEEIO_JAVA_VERSION} : "
            echo " [--------------------------------------------------------------------------------] "
            docker build -f images/java/Dockerfile --build-arg OPENJDK_VERSION=${GRAVITEEIO_JAVA_VERSION} -t graviteeio/java:${GRAVITEEIO_JAVA_VERSION} images/java/
            docker tag graviteeio/java graviteeio/java:${GRAVITEEIO_JAVA_VERSION}
            docker tag graviteeio/java:${GRAVITEEIO_JAVA_VERSION} graviteeio/java:latest
            docker images
            echo " [--------------------------------------------------------------------------------] "
            echo "                         DOCKER BUILD [graviteeio/changelog] : "
            echo " [--------------------------------------------------------------------------------] "
            docker build -f images/changelog/Dockerfile -t graviteeio/changelog images/changelog/
            docker tag graviteeio/changelog graviteeio/changelog:latest
            docker images
            echo " [--------------------------------------------------------------------------------] "
            echo "                         DOCKER BUILD [graviteeio/fpm] : "
            echo " [--------------------------------------------------------------------------------] "
            docker build -f images/fpm/rpm/Dockerfile -t graviteeio/fpm images/fpm/rpm/
            docker tag graviteeio/fpm graviteeio/fpm:latest
            docker images
            echo " [--------------------------------------------------------------------------------] "
            echo "                         DOCKER BUILD [graviteeio/httpd] : "
            echo " [--------------------------------------------------------------------------------] "
            docker build -f images/httpd/Dockerfile -t graviteeio/httpd images/httpd/
            docker tag graviteeio/httpd graviteeio/httpd:latest
            docker images

            echo " [--------------------------------------------------------------------------------] "
            echo "                         DOCKER BUILD [graviteeio/python:${PYTHON_OCI_TAG}] : "
            echo " [--------------------------------------------------------------------------------] "
            docker build -f images/python/Dockerfile --build-arg PYTHON_OCI_TAG=${GRAVITEEIO_PYTHON_VERSION} -t graviteeio/python:${PYTHON_OCI_TAG} images/python/
            docker tag graviteeio/python graviteeio/python:${PYTHON_OCI_TAG}
            docker tag graviteeio/python:${PYTHON_OCI_TAG} graviteeio/python:latest
            docker images

            echo " [--------------------------------------------------------------------------------] "
            echo "                         DOCKER BUILD [graviteeio/jenkins] : "
            echo " [--------------------------------------------------------------------------------] "
            docker build -f images/jenkins/Dockerfile -t graviteeio/jenkins images/jenkins/
            docker tag graviteeio/jenkins graviteeio/jenkins:latest
            docker images


      - run:
          name: "Docker tests: Gravitee Container Library"
          command: |
                    pwd
                    ls -allh
                    echo "Gravitee Containers :  Testing the Docker image before pushing it"
                    echo "No tests implemented yet."
      - gravitee/docker_login:
          secrethub_org: << pipeline.parameters.secrethub_org >>
          secrethub_repo: << pipeline.parameters.secrethub_repo >>
      - run:
          name: "Publish Docker Image to Docker Hub: Gravitee Container Library"
          command: |
            pwd
            ls -allh
            docker images
            echo " [++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++] "
            echo " [--------------------------------------------------------------------------------] "
            echo "                            DOCKER PUSH GRAVITEE AM CONTAINER IMAGES : "
            echo " [--------------------------------------------------------------------------------] "
            echo " [++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++] "

            echo " [--------------------------------------------------------------------------------] "
            echo "                         DOCKER PUSH [graviteeio/java:${GRAVITEEIO_JAVA_VERSION} : "
            echo " [--------------------------------------------------------------------------------] "
            if [ "${DRY_RUN}" == "false" ]; then
              # --->>> NO IT IS NOT A DRY RUN
              echo "# --->>> NO IT IS NOT A DRY RUN : GO DOCKER PUSH"
              if [ "${TAG_LATEST}" == "true" ]; then
                # --->>> NO IT IS NOT A DRY RUN
                echo "# --->>> NO IT IS NOT A DRY RUN : THIS IS A LATEST RELEASE"
                docker push graviteeio/java
                docker push graviteeio/java:latest
                docker push graviteeio/java:${GRAVITEEIO_JAVA_VERSION}
              else
                echo "# --->>> THIS IS A DRY RUN : THIS IS NOT A LATEST RELEASE, SO WILL DOCKER PUSH ONLY [${RELEASE_VERSION}]=[${RELEASE_VERSION_MAJOR}.${RELEASE_VERSION_MINOR}.${RELEASE_VERSION_PATCH}]"
                docker push graviteeio/java
                docker push graviteeio/java:${GRAVITEEIO_JAVA_VERSION}
              fi;
            else
              echo "# --->>> THIS IS A DRY RUN : SKIPPING DOCKER PUSH"
            fi;
            echo " [--------------------------------------------------------------------------------] "
            echo "                         DOCKER PUSH [graviteeio/changelog] : "
            echo " [--------------------------------------------------------------------------------] "
            if [ "${DRY_RUN}" == "false" ]; then
              # --->>> NO IT IS NOT A DRY RUN
              echo "# --->>> NO IT IS NOT A DRY RUN : GO DOCKER PUSH"
              if [ "${TAG_LATEST}" == "true" ]; then
                # --->>> NO IT IS NOT A DRY RUN
                echo "# --->>> NO IT IS NOT A DRY RUN : THIS IS A LATEST RELEASE"
                docker push graviteeio/changelog
                docker push graviteeio/changelog:latest
              else
                echo "# --->>> THIS IS A DRY RUN : THIS IS NOT A LATEST RELEASE, SO WILL DOCKER PUSH ONLY [${RELEASE_VERSION}]=[${RELEASE_VERSION_MAJOR}.${RELEASE_VERSION_MINOR}.${RELEASE_VERSION_PATCH}]"
                docker push graviteeio/changelog
              fi;
            else
              echo "# --->>> THIS IS A DRY RUN : SKIPPING DOCKER PUSH"
            fi;
            echo " [--------------------------------------------------------------------------------] "
            echo "                         DOCKER PUSH [graviteeio/fpm] : "
            echo " [--------------------------------------------------------------------------------] "
            if [ "${DRY_RUN}" == "false" ]; then
              # --->>> NO IT IS NOT A DRY RUN
              echo "# --->>> NO IT IS NOT A DRY RUN : GO DOCKER PUSH"
              if [ "${TAG_LATEST}" == "true" ]; then
                # --->>> NO IT IS NOT A DRY RUN
                echo "# --->>> NO IT IS NOT A DRY RUN : THIS IS A LATEST RELEASE"
                docker push graviteeio/fpm
                docker push graviteeio/fpm:latest
              else
                echo "# --->>> THIS IS A DRY RUN : THIS IS NOT A LATEST RELEASE, SO WILL DOCKER PUSH ONLY [${RELEASE_VERSION}]=[${RELEASE_VERSION_MAJOR}.${RELEASE_VERSION_MINOR}.${RELEASE_VERSION_PATCH}]"
                docker push graviteeio/fpm
              fi;
            else
              echo "# --->>> THIS IS A DRY RUN : SKIPPING DOCKER PUSH"
            fi;
            echo " [--------------------------------------------------------------------------------] "
            echo "                         DOCKER PUSH [graviteeio/httpd] : "
            echo " [--------------------------------------------------------------------------------] "
            if [ "${DRY_RUN}" == "false" ]; then
              # --->>> NO IT IS NOT A DRY RUN
              echo "# --->>> NO IT IS NOT A DRY RUN : GO DOCKER PUSH"
              if [ "${TAG_LATEST}" == "true" ]; then
                # --->>> NO IT IS NOT A DRY RUN
                echo "# --->>> NO IT IS NOT A DRY RUN : THIS IS A LATEST RELEASE"
                docker push graviteeio/httpd
                docker push graviteeio/httpd:latest
              else
                echo "# --->>> THIS IS A DRY RUN : THIS IS NOT A LATEST RELEASE, SO WILL DOCKER PUSH ONLY [${RELEASE_VERSION}]=[${RELEASE_VERSION_MAJOR}.${RELEASE_VERSION_MINOR}.${RELEASE_VERSION_PATCH}]"
                docker push graviteeio/httpd
              fi;
            else
              echo "# --->>> THIS IS A DRY RUN : SKIPPING DOCKER PUSH"
            fi;

            echo " [--------------------------------------------------------------------------------] "
            echo "                         DOCKER PUSH [graviteeio/python:${PYTHON_OCI_TAG}] : "
            echo " [--------------------------------------------------------------------------------] "
            if [ "${DRY_RUN}" == "false" ]; then
              # --->>> NO IT IS NOT A DRY RUN
              echo "# --->>> NO IT IS NOT A DRY RUN : GO DOCKER PUSH"
              if [ "${TAG_LATEST}" == "true" ]; then
                # --->>> NO IT IS NOT A DRY RUN
                echo "# --->>> NO IT IS NOT A DRY RUN : THIS IS A LATEST RELEASE"
                docker push graviteeio/python
                docker push graviteeio/python:latest
                docker push graviteeio/python:${PYTHON_OCI_TAG}
              else
                echo "# --->>> THIS IS A DRY RUN : THIS IS NOT A LATEST RELEASE, SO WILL DOCKER PUSH ONLY [${RELEASE_VERSION}]=[${RELEASE_VERSION_MAJOR}.${RELEASE_VERSION_MINOR}.${RELEASE_VERSION_PATCH}]"
                docker push graviteeio/python
                docker push graviteeio/python:${PYTHON_OCI_TAG}
              fi;
            else
              echo "# --->>> THIS IS A DRY RUN : SKIPPING DOCKER PUSH"
            fi;
            echo " [--------------------------------------------------------------------------------] "
            echo "                         DOCKER PUSH [graviteeio/jenkins] : "
            echo " [--------------------------------------------------------------------------------] "
            if [ "${DRY_RUN}" == "false" ]; then
              # --->>> NO IT IS NOT A DRY RUN
              echo "# --->>> NO IT IS NOT A DRY RUN : GO DOCKER PUSH"
              if [ "${TAG_LATEST}" == "true" ]; then
                # --->>> NO IT IS NOT A DRY RUN
                echo "# --->>> NO IT IS NOT A DRY RUN : THIS IS A LATEST RELEASE"
                docker push graviteeio/jenkins
                docker push graviteeio/jenkins:latest
              else
                echo "# --->>> THIS IS A DRY RUN : THIS IS NOT A LATEST RELEASE, SO WILL DOCKER PUSH ONLY [${RELEASE_VERSION}]=[${RELEASE_VERSION_MAJOR}.${RELEASE_VERSION_MINOR}.${RELEASE_VERSION_PATCH}]"
                docker push graviteeio/jenkins
              fi;
            else
              echo "# --->>> THIS IS A DRY RUN : SKIPPING DOCKER PUSH"
            fi;

workflows:
  version: 2.1
  docker_build_and_push_apim_3x:
    when:
      equal: [ apim_3x, << pipeline.parameters.gio_product >> ]
    jobs:
      # One big job Because Management UI EE Image
      # is defined FROM Management UI CE
      - ce_and_ee_build_n_push_apim_3x_job:
          context: cicd-orchestrator
  docker_build_and_push_apim_1x:
    when:
      equal: [ apim_1x, << pipeline.parameters.gio_product >> ]
    jobs:
      # One big job Because Management UI EE Image
      # is defined FROM Management UI CE
      - ce_and_ee_build_n_push_apim_1x_job:
          context: cicd-orchestrator
  docker_build_and_push_am_v2:
    when:
      equal: [ am_v2, << pipeline.parameters.gio_product >> ]
    jobs:
      # ---
      # Builds and push AM Community Edition Images
      - build_n_push_am_ce_job:
          context: cicd-orchestrator
      # ---
      # Builds and push AM v2 Entreprise Edition Images
      - build_n_push_am_ee_v2_gateway_job:
          context: cicd-orchestrator
          requires:
            - build_n_push_am_ce_job
      - build_n_push_am_ee_v2_api_job:
          context: cicd-orchestrator
          requires:
            - build_n_push_am_ce_job
      - build_n_push_am_ee_v2_ui_job:
          context: cicd-orchestrator
          requires:
            - build_n_push_am_ce_job

  docker_build_and_push_am_v3:
    when:
      equal: [ am_v3, << pipeline.parameters.gio_product >> ]
    jobs:
      # ---
      # Builds and push AM Community Edition Images
      - build_n_push_am_ce_job:
          context: cicd-orchestrator
      # ---
      # Builds and push AM v3 Entreprise Edition Images
      - build_n_push_am_ee_v3_gateway_job:
          context: cicd-orchestrator
          requires:
            - build_n_push_am_ce_job
      - build_n_push_am_ee_v3_api_job:
          context: cicd-orchestrator
          requires:
            - build_n_push_am_ce_job
      - build_n_push_am_ee_v3_ui_job:
          context: cicd-orchestrator
          requires:
            - build_n_push_am_ce_job

  gravitee_oci_lib_job:
    when:
      equal: [ oci_lib, << pipeline.parameters.gio_product >> ]
    jobs:
      # ---
      # This one builds and push all Gravitee Container Image Library, among which :
      # graviteeio/java:8 Image, used by Gravitee AM EE Docker image build
      # ---
      # The graviteeio/java:8 should be stripped of the dependencies of
      # Gravitee AM EE Images : it's so simple not worth making a lib.
      # ---
      # graviteeio/changelog
      # etc...
      - gravitee_oci_lib_job:
          context: cicd-orchestrator
  # ---
  # Blank process invoked by default
  none:
    when:
      equal: [ none, << pipeline.parameters.gio_product >> ]
    jobs:
      - empty_job:
          context: ricard-io-cicd
          filters:
            branches:
              ignore:
                # --- git flow
                - master
                - ci2
                - /^.*/
                # ---
